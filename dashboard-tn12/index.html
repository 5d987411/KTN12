<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASPA TN12 Dashboard</title>
    <style>
        :root {
            --bg-primary: #000000;
            --bg-card: #0a0a0a;
            --bg-card-hover: #111111;
            --bg-input: #050505;
            --accent: #00ff88;
            --accent-dim: #005533;
            --accent-glow: rgba(0, 255, 136, 0.15);
            --text: #e0e0e0;
            --text-muted: #404040;
            --border: #1a1a1a;
            --border-hover: #2a2a2a;
            --error: #ff4444;
            --warning: #ffaa00;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            font-size: 13px;
        }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid var(--border); margin-bottom: 24px;
        }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo h1 { font-size: 18px; font-weight: 600; }
        .logo-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .network-badge { background: var(--bg-card); border: 1px solid var(--border); padding: 6px 14px; border-radius: 4px; font-size: 11px; color: var(--text-muted); }
        .network-badge span { color: var(--accent); }
        
        .top-section { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .card-title { font-size: 11px; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
        
        .wallet-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 4px; font-family: inherit; font-size: 11px; margin-bottom: 8px; }
        .wallet-input:focus { outline: none; border-color: var(--accent); }
        
        .balance-display { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .balance-display:last-child { border-bottom: none; }
        .balance-label { font-size: 10px; color: var(--text-muted); }
        .balance-value { font-size: 14px; font-weight: 600; color: var(--accent); }
        
        .btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 8px 16px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; transition: all 0.2s; }
        .btn:hover { border-color: var(--accent); color: var(--accent); }
        .btn-primary { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        .btn-primary:hover { background: var(--accent); color: #000; }
        
        .main-section { display: grid; grid-template-columns: 200px 300px 1fr; gap: 16px; }
        
        .cmd-sidebar { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .cat-header { background: var(--bg-input); padding: 10px 12px; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); }
        .cmd-btns { padding: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
        .chip-btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted); padding: 6px 10px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 11px; }
        .chip-btn:hover { border-color: var(--accent); color: var(--accent); }
        .chip-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        
        .params-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .param-group { margin-bottom: 12px; }
        .param-label { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }
        .param-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 4px; font-family: inherit; font-size: 12px; }
        .param-input:focus { outline: none; border-color: var(--accent); }
        .run-btn { width: 100%; background: var(--accent); border: none; color: #000; padding: 12px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 13px; font-weight: 600; margin-top: 16px; }
        .run-btn:hover { opacity: 0.9; }
        
        .console-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; }
        .console-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); }
        .console-title { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .console-content { flex: 1; padding: 16px; overflow-y: auto; font-size: 12px; line-height: 1.6; }
        .console-input-area { display: flex; border-top: 1px solid var(--border); }
        .console-input { flex: 1; background: var(--bg-input); border: none; color: var(--text); padding: 12px 16px; font-family: inherit; font-size: 12px; }
        .console-input:focus { outline: none; }
        
        .cmd-line { color: var(--accent); margin-bottom: 8px; }
        .output-line { color: var(--text-muted); margin-bottom: 4px; }
        .error-line { color: var(--error); }
        .success-line { color: var(--accent); }
        
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: #000; padding: 12px 24px; border-radius: 4px; font-weight: 600; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
        
        .info-box { background: var(--bg-input); border: 1px solid var(--border); padding: 12px; border-radius: 4px; font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo"><div class="logo-dot"></div><h1>KASPA TN12 Dashboard</h1></div>
            <div class="network-badge" id="headerStats">
                SERVICES: 
                <span id="serviceKaspad" style="color:#888">Kaspad...</span> | 
                <span id="serviceMiner" style="color:#888">Miner...</span> | 
                <span id="serviceRothschild" style="color:#888">Rothschild...</span> |
                NETWORK: <span id="networkName">TESTNET 12</span> | | 
                IP: <span id="sysIP">-</span> | 
                HD: <span id="sysHD">-</span> | 
                KTN12: <span id="ktn12Size">-</span> | 
                Chain: <span id="chainSize">-</span> | 
                Hashrate: <span id="minerHashrate">-</span> | 
                Kaspad TPS: <span id="nodeTps">-</span> | 
                Rothschild TPS: <span id="txTps">-</span>
            </div>
        </header>
        
        <div class="top-section">
            <div class="card">
                <div class="card-title">① Wallet A (Main - Miner)</div>
                <input type="text" class="wallet-input" id="walletA" placeholder="Address" value="kaspatest:qp2ltc576eyy8hag0tckl9kqk62cvfz7p2egrlczyw9978zsh322jtnrx469r">
                <input type="text" class="wallet-input" id="walletAKey" placeholder="Private Key (hex)" style="margin-top:4px;font-family:monospace;font-size:11px">
                <div class="balance-display">
                    <span class="balance-label">ADDRESS</span>
                    <span class="balance-value" id="addrA">-</span>
                </div>
                <div class="balance-display">
                    <span class="balance-label">BALANCE</span>
                    <span class="balance-value" id="balA">-</span>
                </div>
                <button class="btn" onclick="refreshWallet('A')" style="width:100%">↻ Refresh</button>
            </div>
            
            <div class="card">
                <div class="card-title">② Wallet B (Recipient)</div>
                <input type="text" class="wallet-input" id="walletB" placeholder="Address" value="kaspatest:qpx598t8l8l6g7ntq37fd9ecq7g2s90vk376tu28u4r7cnwf4nvmcruc3nd4d">
                <input type="text" class="wallet-input" id="walletBKey" placeholder="Private Key (hex)" style="margin-top:4px;font-family:monospace;font-size:11px">
                <div class="balance-display">
                    <span class="balance-label">ADDRESS</span>
                    <span class="balance-value" id="addrB">-</span>
                </div>
                <div class="balance-display">
                    <span class="balance-label">BALANCE</span>
                    <span class="balance-value" id="balB">-</span>
                </div>
                <button class="btn" onclick="refreshWallet('B')" style="width:100%">↻ Refresh</button>
            </div>
            
            <div class="card">
                <div class="card-title">③ Wallet C (Send From)</div>
                <input type="text" class="wallet-input" id="walletC" placeholder="Address" value="">
                <input type="text" class="wallet-input" id="walletCKey" placeholder="Private Key (hex)" style="margin-top:4px;font-family:monospace;font-size:11px">
                <div class="balance-display">
                    <span class="balance-label">ADDRESS</span>
                    <span class="balance-value" id="addrC">-</span>
                </div>
                <div class="balance-display">
                    <span class="balance-label">BALANCE</span>
                    <span class="balance-value" id="balC">-</span>
                </div>
                <button class="btn" onclick="refreshWallet('C')" style="width:100%">↻ Refresh</button>
            </div>
        </div>
        
        <div class="main-section">
            <div class="cmd-sidebar" id="cmdSidebar">
                <div class="card-title" style="padding:0 0 12px 0">④ Commands</div>
            </div>
            
            <div class="params-panel">
                <div class="card-title" id="paramsTitle">⑤ Parameters</div>
                <div id="paramsForm">
                    <div class="info-box">Click a command button to see parameters</div>
                </div>
            </div>
            
            <div class="console-panel">
                <div class="console-header">
                    <span class="console-title">⑥ Console</span>
                    <input type="text" id="consoleInput" placeholder="Type command..." style="flex:1;max-width:300px;margin:0 12px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:4px;font-size:12px" onkeypress="handleConsoleEnter(event)">
                    <button class="btn" onclick="clearConsole()">Clear</button>
                </div>
                <div class="console-content" id="consoleOutput"></div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast">Copied!</div>

    <script>
        const API_BASE = 'https://api-tn12.kaspa.org';
        
        let minerRunning = false;
        let rothschildRunning = false;
        
        const CATEGORIES = {
            'WALLET': ['generate', 'load', 'send'],
            'MINING': ['miner-status', 'miner-start', 'rothschild-start', 'rothschild-stop'],
            'SILVERSCRIPT': ['silver-compile', 'silver-list'],
            'CONTRACTS': ['p2pkh', 'multisig', 'escrow', 'hodl', 'mecenas'],
            'COMPILER': ['compile', 'deploy']
        };
        
        const COMMANDS = {
            'generate': { 
                desc: 'Generate new wallet', 
                params: [],
                action: () => runCLI('generate')
            },
            'load': { 
                desc: 'Load from private key', 
                params: [{name: 'private_key', placeholder: 'Private key hex'}],
                action: (args) => runCLI('load ' + args[0])
            },
            'balance': { 
                desc: 'Check balance', 
                params: [{name: 'address', placeholder: 'Address', id: 'balanceAddr'}],
                action: (args) => {
                    const addr = args[0] || document.getElementById('walletB').value || document.getElementById('walletA').value;
                    checkBalance(addr);
                }
            },
            'utxos': { 
                desc: 'List UTXOs', 
                params: [{name: 'address', placeholder: 'Address'}],
                action: (args) => checkUTXOs(args[0])
            },
            'send': { 
                desc: 'Send KAS', 
                params: [
                    {name: 'private_key', placeholder: 'Private key', id: 'sendKey'},
                    {name: 'recipient', placeholder: 'Recipient address', id: 'sendTo'},
                    {name: 'amount', placeholder: 'Amount (TKAS)', id: 'sendAmount'}
                ],
                action: (args) => sendKAS(args[0], args[1], args[2])
            },
            'miner-status': { 
                desc: 'Get miner status', 
                params: [],
                action: () => checkMinerStatus()
            },
            'miner-start': { 
                desc: 'Toggle CPU miner', 
                params: [{name: 'address', placeholder: 'Mining address', id: 'minerAddr'}, {name: 'threads', placeholder: 'Threads', default: '2'}],
                action: (args) => toggleMiner(args[0], args[1])
            },
            'rothschild-start': { 
                desc: 'Toggle TX generator', 
                params: [
                    {name: 'version', placeholder: 'rusty-kaspa or smartgoo', default: 'rusty-kaspa', id: 'rothschildVersion'},
                    {name: 'private_key', placeholder: 'Private key hex', id: 'rothschildKey'},
                    {name: 'recipient', placeholder: 'Recipient address', id: 'rothschildTo'},
                    {name: 'tps', placeholder: 'TPS (tx/sec)', default: '1', id: 'rothschildTps'},
                    {name: 'threads', placeholder: 'Threads (0=auto)', default: '2', id: 'rothschildThreads'},
                    {name: 'priority_fee', placeholder: 'Priority fee', default: '0', id: 'rothschildFee'},
                    {name: 'send_amount', placeholder: 'Send amount (TKAS)', default: '', id: 'rothschildAmount'},
                    {name: 'randomize_fee', placeholder: 'yes/no', default: 'no', id: 'rothschildRandFee'},
                    {name: 'randomize_tx_version', placeholder: 'yes/no', default: 'no', id: 'rothschildRandTx'}
                ],
                action: (args) => startRothschild(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8])
            },
            'rothschild-stop': { 
                desc: 'Stop TX generator', 
                params: [],
                action: () => stopRothschild()
            },
            'silver-compile': { 
                desc: 'Compile SilverScript', 
                params: [
                    {name: 'source', placeholder: 'Source .sil file', id: 'silverSource'},
                    {name: 'args', placeholder: 'Constructor args (optional)', id: 'silverArgs'},
                    {name: 'output', placeholder: 'Output JSON file', id: 'silverOutput'}
                ],
                action: (args) => compileSilverScript(args[0], args[1], args[2])
            },
            'silver-list': { 
                desc: 'List Examples', 
                params: [],
                action: () => listSilverExamples()
            },
            'p2pkh': { 
                desc: 'P2PKH Contract', 
                params: [{name: 'args', placeholder: 'Arguments JSON'}],
                action: (args) => compileContract('p2pkh', args[0])
            },
            'multisig': { 
                desc: 'Multisig Contract', 
                params: [{name: 'args', placeholder: 'Arguments JSON'}],
                action: (args) => compileContract('multisig', args[0])
            },
            'escrow': { 
                desc: 'Escrow Contract', 
                params: [{name: 'args', placeholder: 'Arguments JSON'}],
                action: (args) => compileContract('escrow', args[0])
            },
            'hodl': { 
                desc: 'HODL Vault', 
                params: [{name: 'args', placeholder: 'Arguments JSON'}],
                action: (args) => compileContract('hodl_vault', args[0])
            },
            'mecenas': { 
                desc: 'Mecenas Contract', 
                params: [{name: 'args', placeholder: 'Arguments JSON'}],
                action: (args) => compileContract('mecenas', args[0])
            },
            'compile': { 
                desc: 'Compile SilverScript', 
                params: [{name: 'file', placeholder: 'Contract file'}],
                action: (args) => compileContract(args[0], '')
            },
            'deploy': { 
                desc: 'Deploy Contract', 
                params: [{name: 'contract', placeholder: 'Contract JSON'}, {name: 'private_key', placeholder: 'Private key'}],
                action: (args) => deployContract(args[0], args[1])
            }
        };
        let currentCmd = null;
        
        function init() {
            renderCommands();
            refreshWallet('A');
            refreshWallet('B');
            updateStats();
            setInterval(updateStats, 5000);
            log('Console ready. Type commands or use buttons.');
        }
        
        async function updateStats() {
            try {
                const [serviceRes, sysRes, minerRes, nodeRes, txRes] = await Promise.all([
                    fetch('/api/service-status'),
                    fetch('/api/system-info'),
                    fetch('/api/miner-status'),
                    fetch('/api/node-status'),
                    fetch('/api/tx-status')
                ]);
                const services = await serviceRes.json();
                const sys = await sysRes.json();
                const miner = await minerRes.json();
                const node = await nodeRes.json();
                const tx = await txRes.json();
                
                // Update service status indicators
                const kaspadEl = document.getElementById('serviceKaspad');
                const minerEl = document.getElementById('serviceMiner');
                const rothschildEl = document.getElementById('serviceRothschild');
                
                kaspadEl.textContent = 'Kaspad: ' + (services.kaspad === 'running' ? '✓' : '✗');
                kaspadEl.style.color = services.kaspad === 'running' ? '#4ade80' : '#f87171';
                
                minerEl.textContent = 'Miner: ' + (services.miner === 'running' ? '✓' : '✗');
                minerEl.style.color = services.miner === 'running' ? '#4ade80' : '#f87171';
                
                rothschildEl.textContent = 'Rothschild: ' + (services.rothschild === 'running' ? '✓' : '✗');
                rothschildEl.style.color = services.rothschild === 'running' ? '#4ade80' : '#f87171';
                
                // Update system info
                document.getElementById('sysIP').textContent = sys.ip;
                document.getElementById('sysHD').textContent = sys.hd;
                document.getElementById('ktn12Size').textContent = sys.ktn12Size;
                document.getElementById('chainSize').textContent = sys.chainSize;
                
                document.getElementById('minerHashrate').textContent = miner.utxoSync || (miner.running ? (miner.hashrate || 'Syncing...') : 'OFF');
                document.getElementById('nodeTps').textContent = node.syncPercent ? ('Syncing ' + node.syncPercent) : (node.syncing ? 'Syncing...' : (node.tps || 'N/A'));
                document.getElementById('txTps').textContent = tx.running ? (tx.tps || '0') : 'OFF';
            } catch(e) {
                console.log('Stats update error:', e);
            }
        }
        
        function renderCommands() {
            const sidebar = document.getElementById('cmdSidebar');
            Object.entries(CATEGORIES).forEach(([cat, cmds]) => {
                const header = document.createElement('div');
                header.className = 'cat-header';
                header.textContent = cat;
                sidebar.appendChild(header);
                
                const div = document.createElement('div');
                div.className = 'cmd-btns';
                cmds.forEach(cmd => {
                    const btn = document.createElement('button');
                    btn.className = 'chip-btn';
                    btn.textContent = cmd;
                    btn.onclick = () => showParams(cmd);
                    div.appendChild(btn);
                });
                sidebar.appendChild(div);
            });
        }
        
        function showParams(cmdName) {
            currentCmd = cmdName;
            const cmd = COMMANDS[cmdName];
            document.getElementById('paramsTitle').textContent = cmdName.toUpperCase();
            
            let html = '<div class="info-box">' + cmd.desc + '</div>';
            
            // For miner-start, check if running and show/hide params accordingly
            if (cmdName === 'miner-start') {
                fetch('/api/miner-status').then(r => r.json()).then(stats => {
                    minerRunning = stats.running;
                    renderMinerParams(minerRunning);
                }).catch(() => {
                    minerRunning = false;
                    renderMinerParams(false);
                });
                return;
            }
            
            // For rothschild-start, check if running and show/hide params accordingly
            if (cmdName === 'rothschild-start') {
                fetch('/api/tx-status').then(r => r.json()).then(stats => {
                    rothschildRunning = stats.running;
                    renderRothschildParams(rothschildRunning);
                }).catch(() => {
                    rothschildRunning = false;
                    renderRothschildParams(false);
                });
                return;
            }
            
            if (cmd.params.length === 0) {
                html += '<button class="run-btn" onclick="executeCommand()">▶ RUN</button>';
            } else {
                cmd.params.forEach((p, i) => {
                    const defaultVal = p.default || '';
                    const placeholder = p.placeholder || p.name;
                    const id = p.id || 'param-' + i;
                    let value = defaultVal;
                    let extra = '';
                    
                    // Special handling for send command
                    if (cmdName === 'send') {
                        if (p.id === 'sendKey') {
                            value = document.getElementById('walletCKey').value || '';
                        } else if (p.id === 'sendTo') {
                            value = ''; // Clear recipient for send
                        } else {
                            value = defaultVal;
                        }
                    } else if (p.name === 'private_key' || p.id === 'sendKey' || p.id === 'rothschildKey') {
                        if (document.getElementById('walletAKey').value) extra += '<button type="button" class="chip-btn" onclick="document.getElementById(\'' + id + '\').value=document.getElementById(\'walletAKey\').value">From A</button>';
                    } else if (p.name === 'recipient' || p.id === 'sendTo' || p.id === 'rothschildTo') {
                        value = document.getElementById('walletB').value || defaultVal;
                    } else if (p.name === 'address' || p.id === 'balanceAddr' || p.id === 'minerAddr') {
                        value = document.getElementById('walletA').value || document.getElementById('walletB').value || defaultVal;
                    }
                    html += '<div class="param-group"><div class="param-label">' + p.name + '</div><input type="text" class="param-input" id="' + id + '" placeholder="' + placeholder + '" value="' + value + '">' + extra + '</div>';
                });
                html += '<button class="run-btn" onclick="executeCommand()">▶ RUN</button>';
            }
            
            document.getElementById('paramsForm').innerHTML = html;
        }
        
        function renderMinerParams(isRunning) {
            minerRunning = isRunning;
            const addrValue = document.getElementById('walletA').value || document.getElementById('walletB').value || '';
            let html = '<div class="info-box">' + (isRunning ? 'Miner is running' : 'Start CPU miner') + '</div>';
            
            html += '<div class="param-group"><div class="param-label">address</div><input type="text" class="param-input" id="minerAddr" placeholder="Mining address" value="' + addrValue + '"></div>';
            html += '<div class="param-group"><div class="param-label">threads</div><input type="text" class="param-input" id="param-1" placeholder="Threads" value="2"></div>';
            
            if (isRunning) {
                html += '<button class="run-btn" onclick="stopMiner()">■ MINER-STOP</button>';
            } else {
                html += '<button class="run-btn" onclick="executeCommand()">▶ MINER-START</button>';
            }
            
            document.getElementById('paramsForm').innerHTML = html;
        }
        
        function renderRothschildParams(isRunning) {
            rothschildRunning = isRunning;
            const keyValue = '';
            const toValue = '';
            
            // Fetch and display current status
            fetch('/api/tx-status').then(r => r.json()).then(status => {
                // Get current parameter values from inputs
                const params = {
                    version: document.getElementById('rothschildVersion') ? document.getElementById('rothschildVersion').value : 'rusty-kaspa',
                    private_key: document.getElementById('rothschildKey') ? document.getElementById('rothschildKey').value : '',
                    recipient: document.getElementById('rothschildTo') ? document.getElementById('rothschildTo').value : '',
                    tps: document.getElementById('rothschildTps') ? document.getElementById('rothschildTps').value : '1',
                    threads: document.getElementById('rothschildThreads') ? document.getElementById('rothschildThreads').value : '2',
                    priority_fee: document.getElementById('rothschildFee') ? document.getElementById('rothschildFee').value : '0',
                    send_amount: document.getElementById('rothschildAmount') ? document.getElementById('rothschildAmount').value : '',
                    randomize_fee: document.getElementById('rothschildRandFee') ? document.getElementById('rothschildRandFee').value : 'no',
                    randomize_tx_version: document.getElementById('rothschildRandTx') ? document.getElementById('rothschildRandTx').value : 'no'
                };
                
                // Log current parameters
                log('Rothschild Status: ' + (isRunning ? 'RUNNING' : 'STOPPED') + ' | TPS: ' + status.tps, isRunning ? 'success' : 'error');
                log('Params: version=' + params.version + ', private_key=' + params.private_key.substring(0, 8) + '..., recipient=' + params.recipient.substring(0, 16) + '..., tps=' + params.tps + ', threads=' + params.threads + ', priority_fee=' + params.priority_fee + ', send_amount=' + params.send_amount + ', randomize_fee=' + params.randomize_fee + ', randomize_tx_version=' + params.randomize_tx_version, 'success');
            }).catch(() => {});
            
            let html = '<div class="info-box">Start TX Generator</div>';
            
            html += '<div class="param-group"><div class="param-label">version</div><input type="text" class="param-input" id="rothschildVersion" placeholder="rusty-kaspa or smartgoo" value="rusty-kaspa"></div>';
            html += '<div class="param-group"><div class="param-label">private_key</div><input type="text" class="param-input" id="rothschildKey" placeholder="Private key hex" value="' + keyValue + '"></div>';
            html += '<div class="param-group"><div class="param-label">recipient</div><input type="text" class="param-input" id="rothschildTo" placeholder="Recipient address" value="' + toValue + '"></div>';
            html += '<div class="param-group"><div class="param-label">tps (tx/sec)</div><input type="text" class="param-input" id="rothschildTps" placeholder="Transactions per second" value="1"></div>';
            html += '<div class="param-group"><div class="param-label">threads</div><input type="text" class="param-input" id="rothschildThreads" placeholder="Threads (0=auto)" value="2"></div>';
            html += '<div class="param-group"><div class="param-label">priority_fee</div><input type="text" class="param-input" id="rothschildFee" placeholder="Priority fee" value="0"></div>';
            html += '<div class="param-group"><div class="param-label">send_amount</div><input type="text" class="param-input" id="rothschildAmount" placeholder="Send amount (TKAS)" value=""></div>';
            html += '<div class="param-group"><div class="param-label">randomize_fee</div><input type="text" class="param-input" id="rothschildRandFee" placeholder="yes/no" value="no"></div>';
            html += '<div class="param-group"><div class="param-label">randomize_tx_version</div><input type="text" class="param-input" id="rothschildRandTx" placeholder="yes/no" value="no"></div>';
            
            // Always show SEND button
            html += '<button class="run-btn" onclick="executeCommand()">▶ SEND</button>';
            
            document.getElementById('paramsForm').innerHTML = html;
        }
        
        function executeCommand() {
            if (!currentCmd) return;
            const cmd = COMMANDS[currentCmd];
            const args = cmd.params.map((p, i) => {
                const id = p.id || 'param-' + i;
                const el = document.getElementById(id);
                return el ? el.value : (p.default || '');
            });
            log('$ ' + cmd.desc);
            cmd.action(args);
        }
        
        async function refreshWallet(which) {
            console.log('refreshWallet called for:', which);
            const input = document.getElementById('wallet' + which);
            const addrEl = document.getElementById('addr' + which);
            const balEl = document.getElementById('bal' + which);
            console.log('Elements found - input:', !!input, 'addrEl:', !!addrEl, 'balEl:', !!balEl);
            
            let value = input.value.trim();
            console.log('Input value:', value);
            if (!value) {
                balEl.textContent = 'No input';
                return;
            }
            
            let address = value;
            
            // Check if it's a private key (64 hex chars)
            if (value.length === 64 && !value.startsWith('kaspatest:')) {
                // It's a private key - use wallet-load to get address
                try {
                    const resp = await fetch('/api/wallet-load', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({privateKey: value})
                    });
                    const data = await resp.json();
                    console.log('Wallet load response:', data);
                    if (data.address) {
                        address = data.address;
                        // Store private key for sending later
                        if (which === 'A') {
                            document.getElementById('walletAKey').value = value;
                        }
                        if (which === 'B') {
                            document.getElementById('walletBKey').value = value;
                        }
                        if (which === 'C') {
                            document.getElementById('walletCKey').value = value;
                        }
                    }
                    if (data.balance !== undefined) {
                        balEl.textContent = data.balance.toFixed(4) + ' TKAS';
                        addrEl.textContent = address.substring(0, 20) + '...';
                        return;
                    }
                } catch(e) {
                    log('Error loading wallet: ' + e.message, 'error');
                }
            }
            
            // It's an address - use public API to get balance
            if (!address.startsWith('kaspatest:')) {
                address = 'kaspatest:' + address;
            }
            
            // Validate address length
            if (address.length < 70 || address.length > 74) {
                addrEl.textContent = 'Invalid address';
                balEl.textContent = 'Error';
                return;
            }
            
            addrEl.textContent = address.substring(0, 20) + '...';
            
            // Get balance from public API
            try {
                const resp = await fetch('/api/wallet/balance?address=' + encodeURIComponent(address));
                const data = await resp.json();
                console.log('Balance response:', data);
                if (data.error) {
                    balEl.textContent = 'Error';
                } else {
                    balEl.textContent = data.balance.toFixed(4) + ' TKAS';
                }
            } catch(e) {
                balEl.textContent = 'Error';
            }
        }
        
        async function checkBalance(address) {
            if (!address) {
                log('Error: No address provided', 'error');
                return;
            }
            // Ensure proper format
            if (!address.startsWith('kaspatest:')) {
                address = 'kaspatest:' + address;
            }
            // Validate address length
            if (address.length < 70 || address.length > 74) {
                log('Error: Invalid address length. Must be 61-63 chars after kaspatest:', 'error');
                return;
            }
            try {
                const resp = await fetch('/api/balance?address=' + encodeURIComponent(address));
                const data = await resp.json();
                if (data.balance) {
                    const bal = Number(data.balance) / 1e8;
                    log('Balance: ' + bal.toFixed(2) + ' TKAS', 'success');
                } else {
                    log('Error: ' + JSON.stringify(data), 'error');
                }
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function checkUTXOs(address) {
            if (!address) {
                log('Error: No address provided', 'error');
                return;
            }
            try {
                const resp = await fetch('/api/utxos?address=' + encodeURIComponent(address));
                const data = await resp.json();
                log('UTXOs: ' + JSON.stringify(data, null, 2));
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function sendKAS(privateKey, recipient, amount) {
            if (!privateKey || !recipient || !amount) {
                log('Error: Missing parameters', 'error');
                return;
            }
            
            // Validate address format
            let address = recipient;
            if (!address.startsWith('kaspatest:')) {
                address = 'kaspatest:' + address;
            }
            // Must be 61-63 chars after prefix (total 70-74)
            const addrPart = address.replace('kaspatest:', '');
            if (addrPart.length < 61 || addrPart.length > 63) {
                log('Error: Invalid address. Must be 61-63 chars after kaspatest: (got ' + addrPart.length + ')', 'error');
                return;
            }
            
            log('Sending ' + amount + ' TKAS to ' + address + '...');
            
            // Use the new wallet/send endpoint
            try {
                const resp = await fetch('/api/wallet/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        privateKey: privateKey,
                        recipient: address,
                        amount: parseFloat(amount)
                    })
                });
                const data = await resp.json();
                if (data.error) {
                    log('Error: ' + data.error, 'error');
                } else if (data.txId && data.txId !== 'check explorer') {
                    log('Sent! TX: ' + data.txId, 'success');
                } else if (data.error) {
                    log('Error: ' + data.error, 'error');
                } else {
                    log('Transaction sent! Check explorer for details.', 'success');
                }
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function checkMinerStatus() {
            try {
                const stats = await fetch('/api/miner-status').then(r => r.json());
                log('Miner Status: Running=' + stats.running + ', Hashrate=' + stats.hashrate, stats.running ? 'success' : 'error');
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function startMiner(address, threads) {
            if (!address) {
                address = document.getElementById('walletA').value;
            }
            if (!address) {
                log('Error: Mining address required', 'error');
                return;
            }
            try {
                const resp = await fetch('/api/miner-start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address: address, threads: threads || 8 })
                });
                const data = await resp.json();
                log('Miner started: ' + (data.pid ? 'PID ' + data.pid : 'OK'), 'success');
                minerRunning = true;
                // Show miner stats
                setTimeout(async () => {
                    try {
                        const stats = await fetch('/api/miner-status').then(r => r.json());
                        const hr = stats.running ? stats.hashrate : '0.00 M/s';
                        log('Hashrate: ' + hr + ', Running: ' + stats.running, 'success');
                        // Show miner log
                        fetch('/api/shell', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ cmd: 'tail -5 miner.log' })
                        }).then(r => r.json()).then(logData => {
                            if (logData.stdout) {
                                log('--- Miner Log ---', 'success');
                                logData.stdout.split('\n').forEach(line => log(line));
                            }
                        });
                    } catch(e) {}
                }, 3000);
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function stopMiner() {
            try {
                await fetch('/api/miner-stop', { method: 'POST' });
                log('Miner stopped', 'success');
                minerRunning = false;
                // Show miner stats
                setTimeout(async () => {
                    try {
                        const stats = await fetch('/api/miner-status').then(r => r.json());
                        const hr = stats.running ? stats.hashrate : '0.00 M/s';
                        log('Hashrate: ' + hr + ', Running: ' + stats.running, 'success');
                    } catch(e) {}
                }, 1000);
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function toggleMiner(address, threads) {
            try {
                const stats = await fetch('/api/miner-status').then(r => r.json());
                minerRunning = stats.running;
            } catch(e) {
                minerRunning = false;
            }
            
            if (minerRunning) {
                await stopMiner();
            } else {
                await startMiner(address, threads);
            }
        }
        
        async function startRothschild(version, privateKey, recipient, tps, threads, priorityFee, sendAmount, randomizeFee, randomizeTxVersion) {
            if (!privateKey || !recipient) {
                log('Error: Private key and recipient required', 'error');
                return;
            }
            
            // First, derive address from private key and check balance
            try {
                log('Checking balance...');
                const addrResp = await fetch('/api/wallet/address?privateKey=' + encodeURIComponent(privateKey));
                const addrData = await addrResp.json();
                
                if (addrData.error) {
                    log('Error: Could not derive address - ' + addrData.error, 'error');
                    return;
                }
                
                const address = addrData.address;
                log('Derived address: ' + address);
                
                // Get balance
                const balResp = await fetch('/api/wallet/balance?address=' + encodeURIComponent(address));
                const balData = await balResp.json();
                
                const balance = balData.balance || 0;
                log('Balance: ' + balance.toFixed(4) + ' TKAS');
                
                if (balance <= 0) {
                    log('Error: Not enough funds (balance: ' + balance.toFixed(4) + ' TKAS)', 'error');
                    return;
                }
            } catch(e) {
                log('Warning: Could not check balance - ' + e.message + ', proceeding anyway');
            }
            
            try {
                const resp = await fetch('/api/rothschild', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        version: version || 'rusty-kaspa',
                        privateKey: privateKey,
                        recipient: recipient,
                        tps: parseInt(tps) || 1,
                        threads: parseInt(threads) || 2,
                        priorityFee: parseInt(priorityFee) || 0,
                        sendAmount: sendAmount ? parseFloat(sendAmount) : null,
                        randomizeFee: randomizeFee === 'yes',
                        randomizeTxVersion: randomizeTxVersion === 'yes'
                    })
                });
                const data = await resp.json();
                
                log('Rothschild started with version: ' + (data.version || version), 'success');
                
                // Check for insufficient funds error in stderr or stdout (but don't stop - UTXO might sync later)
                const outputStr = (data.stderr || '') + (data.stdout || '');
                if (outputStr.includes('not enough funds') || outputStr.includes('Has not enough funds')) {
                    log('⚠️ UTXO NOT SYNCED locally - Rothschild will retry automatically', 'error');
                    log('Your balance shows on public API but local node needs sync', 'error');
                    // Don't stop - let it keep retrying
                }
                
                // Also check rothschild log file after a short delay for fund errors
                setTimeout(async () => {
                    try {
                        const logResp = await fetch('/api/shell', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ cmd: 'tail -10 rothschild.log' })
                        });
                        const logData = await logResp.json();
                        if (logData.stdout && (logData.stdout.includes('not enough funds') || logData.stdout.includes('Has not enough funds'))) {
                            log('⚠️ UTXO NOT SYNCED - Balance shows ' + balance.toFixed(4) + ' TKAS on API but local node needs time to sync', 'error');
                            // Don't stop - let it keep retrying
                        }
                    } catch(e) {}
                }, 3000);
                
                log('Rothschild started: ' + JSON.stringify(data), 'success');
                rothschildRunning = true;
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function stopRothschild() {
            try {
                await fetch('/api/rothschild-stop', {method: 'POST'});
                log('Rothschild stopped', 'success');
                rothschildRunning = false;
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function toggleRothschild(privateKey, recipient, tps, threads, priorityFee, randomizeFee) {
            try {
                const resp = await fetch('/api/tx-status').then(r => r.json());
                rothschildRunning = resp.running;
            } catch(e) {
                rothschildRunning = false;
            }
            
            if (rothschildRunning) {
                await stopRothschild();
            } else {
                await startRothschild(privateKey, recipient, tps, threads, priorityFee, randomizeFee);
            }
        }
        
        async function compileSilverScript(source, args, output) {
            if (!source) {
                log('Error: Source file required', 'error');
                return;
            }
            try {
                log('Compiling ' + source + '...');
                const resp = await fetch('/api/silverscript-compile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sourceFile: source,
                        constructorArgs: args || null,
                        outputFile: output || null
                    })
                });
                const data = await resp.json();
                if (data.error) {
                    log('Error: ' + data.error, 'error');
                } else {
                    log('Compiled successfully!', 'success');
                    if (data.output) {
                        log('Contract: ' + (data.output.contract_name || 'unknown'), 'success');
                        log('Script size: ' + (data.output.script ? data.output.script.length : 'N/A') + ' bytes', 'success');
                        log('Output: ' + (output || source.replace('.sil', '.json')), 'success');
                    }
                }
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function listSilverExamples() {
            try {
                const resp = await fetch('/api/silverscript-examples');
                const examples = await resp.json();
                log('SilverScript Examples:', 'success');
                examples.forEach(ex => {
                    log('  ' + ex.name + ' -> ' + ex.file, 'success');
                });
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        function compileContract(name, args) {
            log('Compiling ' + name + '... (demo)');
            log('Contract: ' + name + ' compiled successfully', 'success');
        }
        
        function deployContract(contractJson, privateKey) {
            log('Deploying ' + contractJson + '... (demo)');
            log('Contract deployed successfully', 'success');
        }
        
        async function runCLI(cmd) {
            log('Running: ' + cmd);
            try {
                const resp = await fetch('/api/run-cmd', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({cmd: cmd})
                });
                const data = await resp.json();
                
                // Check if generated address is valid (61-63 chars after prefix)
                if (cmd === 'generate' && data.address) {
                    const addrLen = data.address.replace('kaspatest:', '').length;
                    if (addrLen < 61 || addrLen > 63) {
                        log('WARNING: Generated address has ' + addrLen + ' chars (need 61-63). Use pre-funded wallets instead.', 'error');
                    } else {
                        log('Generated address is VALID (' + addrLen + ' chars)', 'success');
                    }
                    // Auto-fill wallet A with generated wallet
                    document.getElementById('walletA').value = data.address;
                    document.getElementById('walletAKey').value = data.private_key || '';
                    log('Wallet A auto-filled with new wallet', 'success');
                }
                
                // Handle load command - fill Wallet C
                if (cmd.startsWith('load ') && data.address) {
                    const privKey = cmd.replace('load ', '').trim();
                    document.getElementById('walletC').value = data.address;
                    document.getElementById('walletCKey').value = privKey;
                    refreshWallet('C');
                    log('Loaded to Wallet C: ' + data.address.substring(0, 20) + '...', 'success');
                }
                
                log(JSON.stringify(data, null, 2), 'success');
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        function log(msg, type = '') {
            const output = document.getElementById('consoleOutput');
            const line = document.createElement('div');
            line.className = type === 'error' ? 'error-line' : type === 'success' ? 'success-line' : 'output-line';
            line.textContent = msg;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = '';
        }
        
        function handleConsoleEnter(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('consoleInput');
                const cmd = input.value.trim();
                if (cmd) {
                    log('$ ' + cmd, 'cmd-line');
                    
                    // Execute shell command directly
                    fetch('/api/shell', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ cmd: cmd })
                    })
                    .then(resp => resp.json())
                    .then(data => {
                        if (data.stderr) {
                            log(data.stderr, 'error');
                        }
                        if (data.stdout) {
                            log(data.stdout, 'success');
                        }
                        if (data.error && !data.stdout && !data.stderr) {
                            log('Error: ' + data.error, 'error');
                        }
                    })
                    .catch(e => {
                        log('Error: ' + e.message, 'error');
                    });
                    
                    input.value = '';
                }
            }
        }
        
        init();
    </script>
</body>
</html>
