<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASPA TN12 Dashboard</title>
    <style>
        :root {
            --bg-primary: #000000;
            --bg-card: #0a0a0a;
            --bg-card-hover: #111111;
            --bg-input: #050505;
            --accent: #00ff88;
            --accent-dim: #005533;
            --accent-glow: rgba(0, 255, 136, 0.15);
            --text: #e0e0e0;
            --text-muted: #404040;
            --border: #1a1a1a;
            --border-hover: #2a2a2a;
            --error: #ff4444;
            --warning: #ffaa00;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            font-size: 13px;
        }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid var(--border); margin-bottom: 24px;
        }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo h1 { font-size: 18px; font-weight: 600; }
        .logo-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .network-badge { background: var(--bg-card); border: 1px solid var(--border); padding: 6px 14px; border-radius: 4px; font-size: 11px; color: var(--text-muted); }
        .network-badge span { color: var(--accent); }
        
        .top-section { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .card-title { font-size: 13px; color: #00BFFF; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
        
        .wallet-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 4px; font-family: inherit; font-size: 11px; margin-bottom: 8px; }
        .wallet-input:focus { outline: none; border-color: var(--accent); }
        
        .balance-display { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .balance-display:last-child { border-bottom: none; }
        .balance-label { font-size: 10px; color: var(--text-muted); }
        .balance-value { font-size: 14px; font-weight: 600; color: var(--accent); }
        
        .btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 8px 16px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; transition: all 0.2s; }
        .btn:hover { border-color: var(--accent); color: var(--accent); }
        .btn-primary { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        .btn-primary:hover { background: var(--accent); color: #000; }
        
        .main-section { display: grid; grid-template-columns: 200px 300px 1fr; gap: 16px; }
        
        .cmd-sidebar { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .cat-header { background: var(--bg-input); padding: 10px 12px; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); }
        .cmd-btns { padding: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
        .chip-btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted); padding: 6px 10px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 11px; }
        .chip-btn:hover { border-color: var(--accent); color: var(--accent); }
        .chip-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        
        .params-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .param-group { margin-bottom: 12px; }
        .param-label { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }
        .param-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 4px; font-family: inherit; font-size: 12px; }
        .param-input:focus { outline: none; border-color: var(--accent); }
        .run-btn { width: 100%; background: var(--accent); border: none; color: #000; padding: 12px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 13px; font-weight: 600; margin-top: 16px; }
        .run-btn:hover { opacity: 0.9; }
        
        .console-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; }
        .console-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); }
        .console-title { font-size: 13px; color: #00BFFF; text-transform: uppercase; letter-spacing: 1px; }
        .console-content { flex: 1; padding: 16px; overflow-y: auto; font-size: 12px; line-height: 1.6; }
        .console-input-area { display: flex; border-top: 1px solid var(--border); }
        .console-input { flex: 1; background: var(--bg-input); border: none; color: var(--text); padding: 12px 16px; font-family: inherit; font-size: 12px; }
        .console-input:focus { outline: none; }
        
        .cmd-line { color: var(--accent); margin-bottom: 8px; }
        .output-line { color: var(--text-muted); margin-bottom: 4px; }
        .error-line { color: var(--error); }
        .success-line { color: var(--accent); }
        
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: #000; padding: 12px 24px; border-radius: 4px; font-weight: 600; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
        
        .info-box { background: var(--bg-input); border: 1px solid var(--border); padding: 12px; border-radius: 4px; font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo"><div class="logo-dot"></div><h1>KASPA TN12 Dashboard</h1></div>
            <div class="network-badge" id="headerStats">
                SERVICES: 
                <span id="serviceKaspad" style="color:#888">Kaspad...</span> | 
                <span id="serviceMiner" style="color:#888">Miner...</span> | 
                <span id="serviceRothschild" style="color:#888">Rothschild...</span> |
                NETWORK: <span id="networkName">TESTNET 12</span> | | 
                IP: <span id="sysIP">-</span> | 
                HD: <span id="sysHD">-</span> | 
                KTN12: <span id="ktn12Size">-</span> | 
                Chain: <span id="chainSize">-</span> | 
                Hashrate: <span id="minerHashrate">-</span> | 
                Kaspad TPS: <span id="nodeTps">-</span> | 
                Rothschild TPS: <span id="txTps">-</span>
            </div>
        </header>
        
        <div class="top-section">
            <div class="card">
                <div class="card-title">1 Wallet A (Main - Miner)</div>
                <input type="text" class="wallet-input" id="walletA" placeholder="Address" value="kaspatest:qp2ltc576eyy8hag0tckl9kqk62cvfz7p2egrlczyw9978zsh322jtnrx469r">
                <input type="text" class="wallet-input" id="walletAKey" placeholder="Private Key (hex)" style="margin-top:4px;font-family:monospace;font-size:11px">
                <div class="balance-display">
                    <span class="balance-label">ADDRESS</span>
                    <span class="balance-value" id="addrA">-</span>
                </div>
                <div class="balance-display">
                    <span class="balance-label">BALANCE</span>
                    <span class="balance-value" id="balA">-</span>
                </div>
                <button class="btn" onclick="refreshWallet('A')" style="width:100%">↻ Refresh</button>
            </div>
            
            <div class="card">
                <div class="card-title">2 Wallet B (Recipient)</div>
                <input type="text" class="wallet-input" id="walletB" placeholder="Address" value="kaspatest:qpx598t8l8l6g7ntq37fd9ecq7g2s90vk376tu28u4r7cnwf4nvmcruc3nd4d">
                <input type="text" class="wallet-input" id="walletBKey" placeholder="Private Key (hex)" style="margin-top:4px;font-family:monospace;font-size:11px">
                <div class="balance-display">
                    <span class="balance-label">ADDRESS</span>
                    <span class="balance-value" id="addrB">-</span>
                </div>
                <div class="balance-display">
                    <span class="balance-label">BALANCE</span>
                    <span class="balance-value" id="balB">-</span>
                </div>
                <button class="btn" onclick="refreshWallet('B')" style="width:100%">↻ Refresh</button>
            </div>
            
            <div class="card">
                <div class="card-title">3 Wallet C (Send From)</div>
                <input type="text" class="wallet-input" id="walletC" placeholder="Address" value="">
                <input type="text" class="wallet-input" id="walletCKey" placeholder="Private Key (hex)" style="margin-top:4px;font-family:monospace;font-size:11px">
                <div class="balance-display">
                    <span class="balance-label">ADDRESS</span>
                    <span class="balance-value" id="addrC">-</span>
                </div>
                <div class="balance-display">
                    <span class="balance-label">BALANCE</span>
                    <span class="balance-value" id="balC">-</span>
                </div>
                <button class="btn" onclick="refreshWallet('C')" style="width:100%">↻ Refresh</button>
            </div>
        </div>
        
        <div class="main-section">
            <div class="cmd-sidebar" id="cmdSidebar">
                <div class="card-title" style="padding:0 0 12px 0">4 Commands</div>
            </div>
            
            <div class="params-panel">
                <div class="card-title" id="paramsTitle">5 Parameters</div>
                <div id="paramsForm">
                    <div class="info-box">Click a command button to see parameters</div>
                </div>
            </div>
            
            <div class="console-panel">
                <div class="console-header">
                    <span class="console-title">6 Console</span>
                    <input type="text" id="consoleInput" placeholder="Type command..." style="flex:1;max-width:300px;margin:0 12px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:4px;font-size:12px" onkeypress="handleConsoleEnter(event)">
                    <button class="btn" onclick="clearConsole()">Clear</button>
                </div>
                <div class="console-content" id="consoleOutput"></div>
            </div>
        </div>
        
        <!-- Panel 7: Kaspad Parameters -->
        <div class="kaspad-panel" style="margin-top: 24px;">
            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>7 Kaspad Parameters</span>
                    <button class="btn" onclick="restartKaspad()">▶ Restart</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Toggle Args:</div>
                        <div id="kaspadToggles" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;"></div>
                    </div>
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">Custom Extra Args:</div>
                        <input type="text" id="kaspadCustomArgs" class="wallet-input" placeholder="--custom-flag --other" style="width: 100%;">
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg-input); border-radius: 4px; font-size: 11px;">
                    <div style="color: var(--text-muted); margin-bottom: 6px;">Command Preview:</div>
                    <code id="kaspadCmdPreview" style="color: var(--accent); word-break: break-all; font-size: 10px;"></code>
                </div>
            </div>
        </div>
        
        <!-- Panel 8: Debug Console -->
        <div class="debug-panel" style="margin-top: 16px;">
            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>8 Debug Console</span>
                    <button class="btn" onclick="refreshDebug()">↻ Refresh</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 12px; font-size: 11px;">
                    <div style="background: var(--bg-input); padding: 10px; border-radius: 4px;">
                        <div style="color: #00BFFF; margin-bottom: 8px;">SYNC STATUS</div>
                        <div id="debugSync">Loading...</div>
                    </div>
                    <div style="background: var(--bg-input); padding: 10px; border-radius: 4px;">
                        <div style="color: #00BFFF; margin-bottom: 8px;">MINER STATUS</div>
                        <div id="debugMiner">Loading...</div>
                    </div>
                    <div style="background: var(--bg-input); padding: 10px; border-radius: 4px;">
                        <div style="color: #00BFFF; margin-bottom: 8px;">NETWORK</div>
                        <div id="debugNetwork">Loading...</div>
                    </div>
                    <div style="background: var(--bg-input); padding: 10px; border-radius: 4px;">
                        <div style="color: #00BFFF; margin-bottom: 8px;">SYSTEM</div>
                        <div id="debugSystem">Loading...</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-top: 12px; font-size: 11px;">
                    <div style="background: var(--bg-input); padding: 10px; border-radius: 4px;">
                        <div style="color: #00BFFF; margin-bottom: 8px;">UTXO CHECK</div>
                        <div style="display: flex; gap: 6px; margin-bottom: 8px;">
                            <input type="text" id="utxoAddress" class="wallet-input" placeholder="kaspatest:..." style="flex:1;">
                            <button class="btn" onclick="checkUTXO()" style="padding: 6px 12px;">Check</button>
                        </div>
                        <div id="debugUTXO">Enter address to check</div>
                    </div>
                    <div style="background: var(--bg-input); padding: 10px; border-radius: 4px;">
                        <div style="color: #00BFFF; margin-bottom: 8px;">RECENT LOGS</div>
                        <div id="debugLogs" style="height: 80px; overflow-y: auto; font-size: 10px; color: var(--text-muted);">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel 9: Command Reference -->
        <div class="cmd-ref-panel" style="margin-top: 16px;">
            <div class="card">
                <div class="card-title">9 Command Reference</div>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-top: 12px; font-size: 11px;">
                    <div>
                        <div style="color: #00BFFF; margin-bottom: 6px;">WALLET</div>
                        <div style="color: #ffffff; line-height: 1.5;">
                            generate - New wallet<br>
                            load &lt;key&gt; - Load key<br>
                            balance &lt;addr&gt; - Check balance<br>
                            utxos &lt;addr&gt; - List UTXOs<br>
                            send &lt;key&gt; &lt;to&gt; &lt;amt&gt;
                        </div>
                    </div>
                    <div>
                        <div style="color: #00BFFF; margin-bottom: 6px;">MINING</div>
                        <div style="color: #ffffff; line-height: 1.5;">
                            miner-status - Status<br>
                            miner-start &lt;addr&gt; &lt;threads&gt;<br>
                            rothschild-start - TX Gen<br>
                            rothschild-stop
                        </div>
                    </div>
                    <div>
                        <div style="color: #00BFFF; margin-bottom: 6px;">KASPA-CLI</div>
                        <div style="color: #ffffff; line-height: 1.5;">
                            wallet create - New wallet<br>
                            wallet balance - Check balance<br>
                            wallet send &lt;to&gt; &lt;amount&gt; - Send<br>
                            settings - Configure<br>
                            server &lt;rpc&gt; - Change RPC<br>
                            <span style="color:#888;"># Example: send 1 KAS</span><br>
                            <span style="color:#00ff88;">kaspa-cli send addr 1</span>
                        </div>
                    </div>
                    <div>
                        <div style="color: #00BFFF; margin-bottom: 6px;">CONTRACTS</div>
                        <div style="color: #ffffff; line-height: 1.5;">
                            p2pkh - P2PKH Contract<br>
                            multisig - Multisig<br>
                            escrow - Escrow<br>
                            hodl - HODL Vault<br>
                            mecenas - Mecenas
                        </div>
                    </div>
                    <div>
                        <div style="color: #00BFFF; margin-bottom: 6px;">COMPILER</div>
                        <div style="color: #ffffff; line-height: 1.5;">
                            silver-compile - Compile<br>
                            silver-list - List Examples<br>
                            compile &lt;file&gt;<br>
                            deploy &lt;contract&gt; &lt;key&gt;
                        </div>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg-input); border-radius: 4px; font-size: 11px;">
                    <div style="color: #00BFFF; margin-bottom: 6px;">CLI BINARIES</div>
                    <div style="color: #ffffff; line-height: 1.5;">
                        ./kaspad - Node daemon | ./kaspa-miner - CPU miner | ./rothschild - TX generator<br>
                        ./kaspa-cli - Wallet CLI (requires TTY) | ./silverc - SilverScript compiler
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel 10: Wallet CLI -->
        <div class="wallet-cli-panel" style="margin-top: 16px;">
            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>10 Wallet CLI (kaspa-graffiti-cli)</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 12px;">
                    <!-- Left: Load Wallet -->
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">LOAD WALLET</div>
                        <input type="text" id="walletCLIPrivateKey" class="wallet-input" placeholder="Private Key (hex)" style="font-family: monospace; font-size: 11px;">
                        <button class="btn btn-primary" onclick="loadWalletCLI()" style="width: 100%; margin-top: 8px;">Load</button>
                        <div style="margin-top: 12px; padding: 10px; background: var(--bg-input); border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-size: 10px; color: var(--text-muted);">ADDRESS</span>
                            </div>
                            <div id="walletCLIAddress" style="color: var(--accent); font-size: 12px; word-break: break-all;">-</div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px; margin-bottom: 6px;">
                                <span style="font-size: 10px; color: var(--text-muted);">BALANCE</span>
                            </div>
                            <div id="walletCLIBalance" style="color: var(--accent); font-size: 16px; font-weight: 600;">-</div>
                        </div>
                        <button class="btn" id="walletCLIMinerBtn" onclick="startMinerFromPanel10()" style="width: 100%; margin-top: 12px; background: #005533; border-color: #00ff88; color: #00ff88;">Start Miner to This Address</button>
                        <div id="walletCLIMinerStatus" style="margin-top: 8px; font-size: 11px; color: var(--text-muted);"></div>
                    </div>
                    <!-- Right: Send -->
                    <div>
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px;">SEND KAS</div>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                            <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; padding: 6px; background: var(--bg-input); border-radius: 4px;">
                                <input type="radio" name="walletCLIMethod" value="public" checked onchange="updateWalletCLIRPC()">
                                <div>
                                    <span style="font-size: 11px; color: var(--text);">Public API (api-tn12.kaspa.org)</span>
                                    <div style="font-size: 10px; color: var(--text-muted);">Direct to public API - reliable, no local sync needed</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; padding: 6px; background: var(--bg-input); border-radius: 4px;">
                                <input type="radio" name="walletCLIMethod" value="local" onchange="updateWalletCLIRPC()">
                                <div>
                                    <span style="font-size: 11px; color: var(--text);">Local RPC (localhost:16210)</span>
                                    <div style="font-size: 10px; color: var(--text-muted);">Via local kaspad - faster but needs UTXO synced</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; padding: 6px; background: var(--bg-input); border-radius: 4px;">
                                <input type="radio" name="walletCLIMethod" value="rothschild" onchange="updateWalletCLIRPC()">
                                <div>
                                    <span style="font-size: 11px; color: var(--text);">Rothschild (TX Generator)</span>
                                    <div style="font-size: 10px; color: var(--text-muted);">High-throughput TX generator - best for load/stress testing</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer; padding: 6px; background: var(--bg-input); border-radius: 4px;">
                                <input type="radio" name="walletCLIMethod" value="kaspa-send" onchange="updateWalletCLIRPC()">
                                <div>
                                    <span style="font-size: 11px; color: var(--text);">kaspa-send (wRPC)</span>
                                    <div style="font-size: 10px; color: var(--text-muted);">Direct wRPC to localhost:17110 - uses wallet-cli for signing</div>
                                </div>
                            </label>
                        </div>
                        <input type="text" id="walletCLIRecipient" class="wallet-input" placeholder="Recipient Address (kaspatest:...)">
                        <input type="text" id="walletCLIAmount" class="wallet-input" placeholder="Amount (KAS)" style="margin-top: 8px;">
                        <button class="btn btn-primary" onclick="sendViaWalletCLI()" style="width: 100%; margin-top: 8px;">Send</button>
                        <div style="margin-top: 12px; padding: 10px; background: var(--bg-input); border-radius: 4px; font-size: 11px; max-height: 150px; overflow-y: auto;">
                            <div id="walletCLIOutput" style="color: var(--text-muted);">Output will appear here...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast">Copied!</div>

    <script>
        const API_BASE = 'https://api-tn12.kaspa.org';
        
        let minerRunning = false;
        let rothschildRunning = false;
        
        const CATEGORIES = {
            'WALLET': ['generate', 'load', 'send'],
            'MINING': ['miner-status', 'miner-start', 'rothschild-start', 'rothschild-stop'],
            'SILVERSCRIPT': ['silver-compile', 'silver-list'],
            'CONTRACTS': ['p2pkh', 'multisig', 'escrow', 'hodl', 'mecenas'],
            'COMPILER': ['compile', 'deploy']
        };
        
        const COMMANDS = {
            'generate': { 
                desc: 'Generate new wallet', 
                params: [],
                action: () => runCLI('generate')
            },
            'load': { 
                desc: 'Load from private key', 
                params: [{name: 'private_key', placeholder: 'Private key hex'}],
                action: (args) => runCLI('load ' + args[0])
            },
            'balance': { 
                desc: 'Check balance', 
                params: [{name: 'address', placeholder: 'Address', id: 'balanceAddr'}],
                action: (args) => {
                    const addr = args[0] || document.getElementById('walletB').value || document.getElementById('walletA').value;
                    checkBalance(addr);
                }
            },
            'utxos': { 
                desc: 'List UTXOs', 
                params: [{name: 'address', placeholder: 'Address'}],
                action: (args) => checkUTXOs(args[0])
            },
            'send': { 
                desc: 'Send KAS', 
                params: [
                    {name: 'private_key', placeholder: 'Private key', id: 'sendKey'},
                    {name: 'recipient', placeholder: 'Recipient address', id: 'sendTo'},
                    {name: 'amount', placeholder: 'Amount (KAS)', id: 'sendAmount'}
                ],
                action: (args) => sendKAS(args[0], args[1], args[2])
            },
            'miner-status': { 
                desc: 'Get miner status', 
                params: [],
                action: () => checkMinerStatus()
            },
            'miner-start': { 
                desc: 'Toggle CPU miner', 
                params: [
                    {name: 'address', placeholder: 'Mining address', id: 'minerAddr'}, 
                    {name: 'threads', placeholder: 'Threads', default: '8', id: 'minerThreads'}
                ],
                action: (args) => toggleMiner(args[0], args[1])
            },
            'rothschild-start': { 
                desc: 'Toggle TX generator', 
                params: [
                    {name: 'version', placeholder: 'rusty-kaspa or smartgoo', default: 'rusty-kaspa', id: 'rothschildVersion'},
                    {name: 'private_key', placeholder: 'Private key hex', id: 'rothschildKey'},
                    {name: 'recipient', placeholder: 'Recipient address', id: 'rothschildTo'},
                    {name: 'tps', placeholder: 'TPS (tx/sec)', default: '1', id: 'rothschildTps'},
                    {name: 'threads', placeholder: 'Threads (0=auto)', default: '2', id: 'rothschildThreads'},
                    {name: 'priority_fee', placeholder: 'Priority fee', default: '0', id: 'rothschildFee'},
                    {name: 'send_amount', placeholder: 'Send amount (KAS)', default: '', id: 'rothschildAmount'},
                    {name: 'randomize_fee', placeholder: 'yes/no', default: 'no', id: 'rothschildRandFee'},
                    {name: 'randomize_tx_version', placeholder: 'yes/no', default: 'no', id: 'rothschildRandTx'},
                    {name: 'timeout', placeholder: 'Timeout (seconds, 0=forever)', default: '0', id: 'rothschildTimeout'},
                    {name: 'custom_args', placeholder: 'Custom args (e.g., --flag)', default: '', id: 'rothschildArgs'}
                ],
                action: (args) => startRothschild(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8], args[9], args[10])
            },
            'rothschild-stop': { 
                desc: 'Stop TX generator', 
                params: [],
                action: () => stopRothschild()
            },
            'silver-compile': { 
                desc: 'Compile SilverScript', 
                params: [
                    {name: 'source', placeholder: 'Source .sil file', id: 'silverSource'},
                    {name: 'args', placeholder: 'Constructor args (optional)', id: 'silverArgs'},
                    {name: 'output', placeholder: 'Output JSON file', id: 'silverOutput'}
                ],
                action: (args) => compileSilverScript(args[0], args[1], args[2])
            },
            'silver-list': { 
                desc: 'List Examples', 
                params: [],
                action: () => listSilverExamples()
            },
            'p2pkh': { 
                desc: 'P2PKH Contract', 
                params: [{name: 'args', placeholder: 'Arguments JSON'}],
                action: (args) => compileContract('p2pkh', args[0])
            },
            'multisig': { 
                desc: 'Multisig Contract', 
                params: [{name: 'args', placeholder: 'Arguments JSON'}],
                action: (args) => compileContract('multisig', args[0])
            },
            'escrow': { 
                desc: 'Escrow Contract', 
                params: [{name: 'args', placeholder: 'Arguments JSON'}],
                action: (args) => compileContract('escrow', args[0])
            },
            'hodl': { 
                desc: 'HODL Vault', 
                params: [{name: 'args', placeholder: 'Arguments JSON'}],
                action: (args) => compileContract('hodl_vault', args[0])
            },
            'mecenas': { 
                desc: 'Mecenas Contract', 
                params: [{name: 'args', placeholder: 'Arguments JSON'}],
                action: (args) => compileContract('mecenas', args[0])
            },
            'compile': { 
                desc: 'Compile SilverScript', 
                params: [{name: 'file', placeholder: 'Contract file'}],
                action: (args) => compileContract(args[0], '')
            },
            'deploy': { 
                desc: 'Deploy Contract', 
                params: [{name: 'contract', placeholder: 'Contract JSON'}, {name: 'private_key', placeholder: 'Private key'}],
                action: (args) => deployContract(args[0], args[1])
            }
        };
        let currentCmd = null;
        
        function init() {
            renderCommands();
            refreshWallet('A');
            refreshWallet('B');
            updateStats();
            renderKaspadToggles();
            refreshDebug();
            setInterval(updateStats, 5000);
            setInterval(refreshDebug, 5000);
            log('Console ready. Type commands or use buttons.');
        }
        
        // Kaspad Parameters
        const KASPAD_FLAGS = [
            { id: 'testnet', name: '--testnet', type: 'flag', default: true, checked: true },
            { id: 'netsuffix', name: '--netsuffix', type: 'value', default: '12', placeholder: '12', note: 'net suffix', checked: true },
            { id: 'utxoindex', name: '--utxoindex', type: 'flag', default: true, checked: true },
            { id: 'rpclisten', name: '--rpclisten', type: 'value', default: '127.0.0.1:16210', placeholder: 'ip:port', note: 'gRPC', checked: true },
            { id: 'rpclisten-json', name: '--rpclisten-json', type: 'flag', default: true, checked: true },
            { id: 'unsaferpc', name: '--unsaferpc', type: 'flag', default: true, checked: true },
            { id: 'enable-unsynced-mining', name: '--enable-unsynced-mining', type: 'flag', default: true, checked: true, note: 'Mine while syncing' },
            { id: 'listen', name: '--listen', type: 'value', default: '0.0.0.0:16311', placeholder: 'ip:port', note: 'P2P', checked: true },
            { id: 'addpeer', name: '--addpeer', type: 'value', default: '23.118.8.168', placeholder: 'ip:port', note: 'peer IP', checked: true },
            { id: 'archival', name: '--archival', type: 'flag', default: false },
            { id: 'perf-metrics', name: '--perf-metrics', type: 'flag', default: false },
            { id: 'reset-db', name: '--reset-db', type: 'flag', default: false },
            { id: 'async-threads', name: '--async-threads', type: 'value', default: '24', placeholder: '2-12', note: '2-12', checked: true },
            { id: 'ram-scale', name: '--ram-scale', type: 'value', default: '2', placeholder: '0.5-4', note: '0.5-4', checked: true },
            { id: 'wrpc', name: '--rpclisten-borsh', type: 'value', default: '127.0.0.1:17110', placeholder: 'host:port', note: 'wRPC', checked: true }
        ];
        
        function renderKaspadToggles() {
            const container = document.getElementById('kaspadToggles');
            if (!container) return;
            
            let html = '';
            KASPAD_FLAGS.forEach(flag => {
                const isChecked = flag.checked ? 'checked' : '';
                if (flag.type === 'flag') {
                    html += `<label style="display:flex;align-items:center;gap:6px;padding:4px;background:var(--bg-card);border-radius:3px;cursor:pointer;">
                        <input type="checkbox" id="kaspad_${flag.id}" ${isChecked} onchange="updateKaspadCmd()">
                        <span style="color:var(--text);font-size:10px;">${flag.name}</span>
                    </label>`;
                } else {
                    const placeholder = flag.placeholder || '';
                    const note = flag.note ? `<span style="color:#666;font-size:8px;margin-left:2px;">(${flag.note})</span>` : '';
                    html += `<label style="display:flex;align-items:center;gap:2px;padding:4px;background:var(--bg-card);border-radius:3px;cursor:pointer;flex-wrap:wrap;">
                        <input type="checkbox" id="kaspad_${flag.id}" ${isChecked} onchange="updateKaspadCmd()">
                        <span style="color:var(--text);font-size:10px;white-space:nowrap;">${flag.name}=</span>
                        <input type="text" id="kaspad_${flag.id}_val" value="${flag.default}" placeholder="${placeholder}" style="width:60px;background:var(--bg-input);border:1px solid var(--border);color:var(--accent);padding:2px 4px;border-radius:2px;font-size:9px;" onchange="updateKaspadCmd()">${note}
                    </label>`;
                }
            });
            container.innerHTML = html;
            updateKaspadCmd();
        }
        
        function updateKaspadCmd() {
            let cmd = './kaspad';
            
            KASPAD_FLAGS.forEach(flag => {
                const checkbox = document.getElementById('kaspad_' + flag.id);
                if (!checkbox) return;
                
                if (checkbox.checked) {
                    if (flag.type === 'flag') {
                        cmd += ' ' + flag.name;
                    } else {
                        const valInput = document.getElementById('kaspad_' + flag.id + '_val');
                        const val = valInput ? valInput.value : flag.default;
                        cmd += ' ' + flag.name + '=' + val;
                    }
                }
            });
            
            // Add appdir
            cmd += ' --appdir=/Users/4dsto/.kaspa-testnet12';
            
            // Add custom args
            const customArgs = document.getElementById('kaspadCustomArgs');
            if (customArgs && customArgs.value) {
                cmd += ' ' + customArgs.value;
            }
            
            const preview = document.getElementById('kaspadCmdPreview');
            if (preview) preview.textContent = cmd;
        }
        
        async function restartKaspad() {
            const cmd = document.getElementById('kaspadCmdPreview').textContent;
            log('=== Kaspad Restart ===');
            
            // Check if miner was running and get its settings
            let minerWasRunning = false;
            let minerAddress = '';
            let minerThreads = '8';
            
            try {
                const minerStatus = await fetch('/api/miner-status').then(r => r.json());
                if (minerStatus.running) {
                    minerWasRunning = true;
                    // Get miner settings from input fields
                    const addrInput = document.getElementById('minerAddr');
                    const threadsInput = document.getElementById('minerThreads');
                    minerAddress = addrInput ? addrInput.value : '';
                    minerThreads = threadsInput ? threadsInput.value : '8';
                    log('Miner was running - will auto-restart after kaspad');
                }
            } catch(e) {
                log('Could not check miner status: ' + e.message);
            }
            
            log('Stopping kaspad...');
            
            try {
                // Kill existing kaspad
                const killResp = await fetch('/api/shell', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cmd: 'pkill -f "kaspad"' })
                });
                const killData = await killResp.json();
                log('Kill: ' + (killData.stdout || killData.stderr || 'OK'));
                
                await new Promise(r => setTimeout(r, 2000));
                
                // Build full command with cd to ktn12 dir
                const ktn12Dir = '/Users/4dsto/ktn12';
                const fullCmd = 'cd ' + ktn12Dir + ' && nohup ' + cmd + ' > kaspad.log 2>&1 &';
                
                log('Command: ' + fullCmd);
                
                const startResp = await fetch('/api/shell', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cmd: fullCmd })
                });
                const startData = await startResp.json();
                
                log('Start: ' + (startData.stdout || startData.stderr || 'OK'), 'success');
                
                // Wait and check status
                await new Promise(r => setTimeout(r, 3000));
                
                const checkResp = await fetch('/api/shell', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cmd: 'pgrep -a kaspad' })
                });
                const checkData = await checkResp.json();
                
                if (checkData.stdout) {
                    log('SUCCESS: Kaspad running - PID: ' + checkData.stdout.trim().split(' ')[0], 'success');
                    
                    // Auto-restart miner if it was running before
                    if (minerWasRunning && minerAddress) {
                        log('Waiting for kaspad to be ready...');
                        await new Promise(r => setTimeout(r, 5000));
                        
                        log('Auto-restarting miner...');
                        try {
                            const minerResp = await fetch('/api/miner-start', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ address: minerAddress, threads: parseInt(minerThreads) || 8 })
                            });
                            const minerData = await minerResp.json();
                            if (minerData.started || minerData.pid) {
                                log('SUCCESS: Miner restarted - PID: ' + (minerData.pid || 'unknown'), 'success');
                            } else {
                                log('WARNING: Miner restart failed', 'error');
                            }
                        } catch(mErr) {
                            log('ERROR: Miner restart failed: ' + mErr.message, 'error');
                        }
                    }
                } else {
                    log('FAILED: Kaspad not running', 'error');
                }
                
                refreshDebug();
                
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        // Debug Console
        async function refreshDebug() {
            try {
                const resp = await fetch('/api/debug');
                const data = await resp.json();
                
                // Sync status
                const syncEl = document.getElementById('debugSync');
                if (syncEl) {
                    syncEl.innerHTML = `Blocks: ${data.sync.blocks || 'N/A'}<br>Headers: ${data.sync.headers || 'N/A'}<br>DAA: ${data.sync.daaScore || 'N/A'}<br>Peers: ${data.sync.peers || 0}`;
                }
                
                // Miner status
                const minerEl = document.getElementById('debugMiner');
                if (minerEl) {
                    const m = data.miner || {};
                    minerEl.innerHTML = `Hashrate: ${m.hashrate || '0 H/s'}<br>Accepted: ${m.accepted || 0}<br>Rejected: ${m.rejected || 0}<br>Status: ${m.running ? '● Running' : '○ Stopped'}`;
                }
                
                // Network
                const netEl = document.getElementById('debugNetwork');
                if (netEl) {
                    const n = data.network || {};
                    netEl.innerHTML = `RPC (16210): ${n.rpc ? '● Online' : '○ Offline'}<br>JSON (18210): ${n.json ? '● Online' : '○ Offline'}<br>P2P (16311): ${n.p2p ? '● Online' : '○ Offline'}`;
                }
                
                // System
                const sysEl = document.getElementById('debugSystem');
                if (sysEl) {
                    const s = data.system || {};
                    sysEl.innerHTML = `CPU: ${s.cpu || '0%'}<br>Memory: ${s.memory || '0 MB'}<br>Disk: ${s.disk || '0 GB'}`;
                }
                
            } catch(e) {
                console.log('Debug refresh error:', e);
            }
        }
        
        async function checkUTXO() {
            const addr = document.getElementById('utxoAddress').value.trim();
            const el = document.getElementById('debugUTXO');
            if (!addr) {
                if (el) el.textContent = 'Enter address to check';
                return;
            }
            
            if (el) el.textContent = 'Checking...';
            
            try {
                const resp = await fetch('/api/debug/utxo?address=' + encodeURIComponent(addr));
                const data = await resp.json();
                
                if (data.error) {
                    if (el) el.innerHTML = `Error: ${data.error}`;
                } else {
                    const balance = (data.balance || 0) / 1e8;
                    const utxos = data.utxos || 0;
                    if (el) el.innerHTML = `Balance: ${balance.toFixed(4)} KAS<br>UTXOs: ${utxos}`;
                }
            } catch(e) {
                if (el) el.textContent = 'Error: ' + e.message;
            }
        }
        
        async function updateStats() {
            try {
                const [serviceRes, sysRes, minerRes, nodeRes, txRes] = await Promise.all([
                    fetch('/api/service-status'),
                    fetch('/api/system-info'),
                    fetch('/api/miner-status'),
                    fetch('/api/node-status'),
                    fetch('/api/tx-status')
                ]);
                const services = await serviceRes.json();
                const sys = await sysRes.json();
                const miner = await minerRes.json();
                const node = await nodeRes.json();
                const tx = await txRes.json();
                
                // Update service status indicators
                const kaspadEl = document.getElementById('serviceKaspad');
                const minerEl = document.getElementById('serviceMiner');
                const rothschildEl = document.getElementById('serviceRothschild');
                
                kaspadEl.textContent = 'Kaspad: ' + (services.kaspad === 'running' ? '✓' : '✗');
                kaspadEl.style.color = services.kaspad === 'running' ? '#4ade80' : '#f87171';
                
                minerEl.textContent = 'Miner: ' + (services.miner === 'running' ? '✓' : '✗');
                minerEl.style.color = services.miner === 'running' ? '#4ade80' : '#f87171';
                
                rothschildEl.textContent = 'Rothschild: ' + (services.rothschild === 'running' ? '✓' : '✗');
                rothschildEl.style.color = services.rothschild === 'running' ? '#4ade80' : '#f87171';
                
                // Update system info
                document.getElementById('sysIP').textContent = sys.ip;
                document.getElementById('sysHD').textContent = sys.hd;
                document.getElementById('ktn12Size').textContent = sys.ktn12Size;
                document.getElementById('chainSize').textContent = sys.chainSize;
                
                document.getElementById('minerHashrate').textContent = miner.utxoSync || (miner.running ? (miner.hashrate || 'Syncing...') : 'OFF');
                document.getElementById('nodeTps').textContent = node.syncPercent ? ('Syncing ' + node.syncPercent) : (node.syncing ? 'Syncing...' : (node.tps || 'N/A'));
                document.getElementById('txTps').textContent = tx.running ? (tx.tps || '0') : 'OFF';
            } catch(e) {
                console.log('Stats update error:', e);
            }
        }
        
        function renderCommands() {
            const sidebar = document.getElementById('cmdSidebar');
            Object.entries(CATEGORIES).forEach(([cat, cmds]) => {
                const header = document.createElement('div');
                header.className = 'cat-header';
                header.textContent = cat;
                sidebar.appendChild(header);
                
                const div = document.createElement('div');
                div.className = 'cmd-btns';
                cmds.forEach(cmd => {
                    const btn = document.createElement('button');
                    btn.className = 'chip-btn';
                    btn.textContent = cmd;
                    btn.onclick = () => showParams(cmd);
                    div.appendChild(btn);
                });
                sidebar.appendChild(div);
            });
        }
        
        function showParams(cmdName) {
            currentCmd = cmdName;
            const cmd = COMMANDS[cmdName];
            document.getElementById('paramsTitle').textContent = cmdName.toUpperCase();
            
            let html = '<div class="info-box">' + cmd.desc + '</div>';
            
            // For miner-start, check if running and show/hide params accordingly
            if (cmdName === 'miner-start') {
                fetch('/api/miner-status').then(r => r.json()).then(stats => {
                    minerRunning = stats.running;
                    renderMinerParams(minerRunning);
                }).catch(() => {
                    minerRunning = false;
                    renderMinerParams(false);
                });
                return;
            }
            
            // For rothschild-start, check if running and show/hide params accordingly
            if (cmdName === 'rothschild-start') {
                fetch('/api/tx-status').then(r => r.json()).then(stats => {
                    rothschildRunning = stats.running;
                    renderRothschildParams(rothschildRunning);
                }).catch(() => {
                    rothschildRunning = false;
                    renderRothschildParams(false);
                });
                return;
            }
            
            if (cmd.params.length === 0) {
                html += '<button class="run-btn" onclick="executeCommand()">▶ RUN</button>';
            } else {
                cmd.params.forEach((p, i) => {
                    const defaultVal = p.default || '';
                    const placeholder = p.placeholder || p.name;
                    const id = p.id || 'param-' + i;
                    let value = defaultVal;
                    let extra = '';
                    
                    // Special handling for send command
                    if (cmdName === 'send') {
                        if (p.id === 'sendKey') {
                            value = document.getElementById('walletCKey').value || '';
                        } else if (p.id === 'sendTo') {
                            value = ''; // Clear recipient for send
                        } else {
                            value = defaultVal;
                        }
                    } else if (p.name === 'private_key' || p.id === 'sendKey' || p.id === 'rothschildKey') {
                        if (document.getElementById('walletAKey').value) extra += '<button type="button" class="chip-btn" onclick="document.getElementById(\'' + id + '\').value=document.getElementById(\'walletAKey\').value">From A</button>';
                    } else if (p.name === 'recipient' || p.id === 'sendTo' || p.id === 'rothschildTo') {
                        value = document.getElementById('walletB').value || defaultVal;
                    } else if (p.name === 'address' || p.id === 'balanceAddr' || p.id === 'minerAddr') {
                        value = document.getElementById('walletA').value || document.getElementById('walletB').value || defaultVal;
                    }
                    html += '<div class="param-group"><div class="param-label">' + p.name + '</div><input type="text" class="param-input" id="' + id + '" placeholder="' + placeholder + '" value="' + value + '">' + extra + '</div>';
                });
                html += '<button class="run-btn" onclick="executeCommand()">▶ RUN</button>';
            }
            
            document.getElementById('paramsForm').innerHTML = html;
        }
        
        function renderMinerParams(isRunning) {
            minerRunning = isRunning;
            const addrValue = document.getElementById('walletA').value || document.getElementById('walletB').value || '';
            let html = '<div class="info-box">' + (isRunning ? 'Miner is running' : 'Start CPU miner') + '</div>';
            
            html += '<div class="param-group"><div class="param-label">address</div><input type="text" class="param-input" id="minerAddr" placeholder="Mining address" value="' + addrValue + '"></div>';
            html += '<div class="param-group"><div class="param-label">threads (2-8)</div><input type="text" class="param-input" id="minerThreads" placeholder="Threads" value="8"></div>';
            
            if (isRunning) {
                html += '<button class="run-btn" onclick="stopMiner()">■ MINER-STOP</button>';
            } else {
                html += '<button class="run-btn" onclick="executeCommand()">▶ MINER-START</button>';
            }
            
            document.getElementById('paramsForm').innerHTML = html;
        }
        
        function renderRothschildParams(isRunning) {
            rothschildRunning = isRunning;
            const keyValue = '';
            const toValue = '';
            
            // Fetch and display current status
            fetch('/api/tx-status').then(r => r.json()).then(status => {
                // Get current parameter values from inputs
                const params = {
                    version: document.getElementById('rothschildVersion') ? document.getElementById('rothschildVersion').value : 'rusty-kaspa',
                    private_key: document.getElementById('rothschildKey') ? document.getElementById('rothschildKey').value : '',
                    recipient: document.getElementById('rothschildTo') ? document.getElementById('rothschildTo').value : '',
                    tps: document.getElementById('rothschildTps') ? document.getElementById('rothschildTps').value : '1',
                    threads: document.getElementById('rothschildThreads') ? document.getElementById('rothschildThreads').value : '2',
                    priority_fee: document.getElementById('rothschildFee') ? document.getElementById('rothschildFee').value : '0',
                    send_amount: document.getElementById('rothschildAmount') ? document.getElementById('rothschildAmount').value : '',
                    randomize_fee: document.getElementById('rothschildRandFee') ? document.getElementById('rothschildRandFee').value : 'no',
                    randomize_tx_version: document.getElementById('rothschildRandTx') ? document.getElementById('rothschildRandTx').value : 'no',
                    timeout: document.getElementById('rothschildTimeout') ? document.getElementById('rothschildTimeout').value : '0',
                    customArgs: document.getElementById('rothschildArgs') ? document.getElementById('rothschildArgs').value : ''
                };
                
                // Log current parameters
                log('Rothschild Status: ' + (isRunning ? 'RUNNING' : 'STOPPED') + ' | TPS: ' + status.tps, isRunning ? 'success' : 'error');
                log('Params: version=' + params.version + ', private_key=' + params.private_key.substring(0, 8) + '..., recipient=' + params.recipient.substring(0, 16) + '..., tps=' + params.tps + ', threads=' + params.threads + ', priority_fee=' + params.priority_fee + ', send_amount=' + params.send_amount + ', randomize_fee=' + params.randomize_fee + ', randomize_tx_version=' + params.randomize_tx_version + ', timeout=' + params.timeout + ', custom_args=' + params.customArgs, 'success');
            }).catch(() => {});
            
            let html = '<div class="info-box">Start TX Generator</div>';
            
            html += '<div class="param-group"><div class="param-label">version</div><input type="text" class="param-input" id="rothschildVersion" placeholder="rusty-kaspa or smartgoo" value="rusty-kaspa"></div>';
            html += '<div class="param-group"><div class="param-label">private_key</div><input type="text" class="param-input" id="rothschildKey" placeholder="Private key hex" value="' + keyValue + '"></div>';
            html += '<div class="param-group"><div class="param-label">recipient</div><input type="text" class="param-input" id="rothschildTo" placeholder="Recipient address" value="' + toValue + '"></div>';
            html += '<div class="param-group"><div class="param-label">tps (tx/sec)</div><input type="text" class="param-input" id="rothschildTps" placeholder="Transactions per second" value="1"></div>';
            html += '<div class="param-group"><div class="param-label">threads</div><input type="text" class="param-input" id="rothschildThreads" placeholder="Threads (0=auto)" value="2"></div>';
            html += '<div class="param-group"><div class="param-label">priority_fee</div><input type="text" class="param-input" id="rothschildFee" placeholder="Priority fee" value="0"></div>';
            html += '<div class="param-group"><div class="param-label">send_amount</div><input type="text" class="param-input" id="rothschildAmount" placeholder="Send amount (KAS)" value=""></div>';
            html += '<div class="param-group"><div class="param-label">randomize_fee</div><input type="text" class="param-input" id="rothschildRandFee" placeholder="yes/no" value="no"></div>';
            html += '<div class="param-group"><div class="param-label">randomize_tx_version</div><input type="text" class="param-input" id="rothschildRandTx" placeholder="yes/no" value="no"></div>';
            html += '<div class="param-group"><div class="param-label">timeout (seconds, 0=forever)</div><input type="text" class="param-input" id="rothschildTimeout" placeholder="0" value="0"></div>';
            html += '<div class="param-group"><div class="param-label">custom_args (e.g., --flag)</div><input type="text" class="param-input" id="rothschildArgs" placeholder="" value=""></div>';
            
            // Always show SEND button
            html += '<button class="run-btn" onclick="executeCommand()">▶ SEND</button>';
            
            document.getElementById('paramsForm').innerHTML = html;
        }
        
        function executeCommand() {
            if (!currentCmd) return;
            const cmd = COMMANDS[currentCmd];
            const args = cmd.params.map((p, i) => {
                const id = p.id || 'param-' + i;
                const el = document.getElementById(id);
                return el ? el.value : (p.default || '');
            });
            log('$ ' + cmd.desc);
            cmd.action(args);
        }
        
        async function refreshWallet(which) {
            console.log('refreshWallet called for:', which);
            const input = document.getElementById('wallet' + which);
            const addrEl = document.getElementById('addr' + which);
            const balEl = document.getElementById('bal' + which);
            console.log('Elements found - input:', !!input, 'addrEl:', !!addrEl, 'balEl:', !!balEl);
            
            let value = input.value.trim();
            console.log('Input value:', value);
            if (!value) {
                balEl.textContent = 'No input';
                return;
            }
            
            let address = value;
            
            // Check if it's a private key (64 hex chars)
            if (value.length === 64 && !value.startsWith('kaspatest:')) {
                // It's a private key - use wallet-load to get address
                try {
                    const resp = await fetch('/api/wallet-load', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({privateKey: value})
                    });
                    const data = await resp.json();
                    console.log('Wallet load response:', data);
                    if (data.address) {
                        address = data.address;
                        // Store private key for sending later
                        if (which === 'A') {
                            document.getElementById('walletAKey').value = value;
                        }
                        if (which === 'B') {
                            document.getElementById('walletBKey').value = value;
                        }
                        if (which === 'C') {
                            document.getElementById('walletCKey').value = value;
                        }
                    }
                    if (data.balance !== undefined) {
                        balEl.textContent = data.balance.toFixed(4) + ' KAS';
                        addrEl.textContent = address.substring(0, 20) + '...';
                        return;
                    }
                } catch(e) {
                    log('Error loading wallet: ' + e.message, 'error');
                }
            }
            
            // It's an address - use public API to get balance
            if (!address.startsWith('kaspatest:')) {
                address = 'kaspatest:' + address;
            }
            
            // Validate address length
            if (address.length < 70 || address.length > 74) {
                addrEl.textContent = 'Invalid address';
                balEl.textContent = 'Error';
                return;
            }
            
            addrEl.textContent = address.substring(0, 20) + '...';
            
            // Get balance from public API
            try {
                const resp = await fetch('/api/wallet/balance?address=' + encodeURIComponent(address));
                const data = await resp.json();
                console.log('Balance response:', data);
                if (data.error) {
                    balEl.textContent = 'Error';
                } else {
                    balEl.textContent = data.balance.toFixed(4) + ' KAS';
                }
            } catch(e) {
                balEl.textContent = 'Error';
            }
        }
        
        async function checkBalance(address) {
            if (!address) {
                log('Error: No address provided', 'error');
                return;
            }
            // Ensure proper format
            if (!address.startsWith('kaspatest:')) {
                address = 'kaspatest:' + address;
            }
            // Validate address length
            if (address.length < 70 || address.length > 74) {
                log('Error: Invalid address length. Must be 61-63 chars after kaspatest:', 'error');
                return;
            }
            try {
                const resp = await fetch('/api/balance?address=' + encodeURIComponent(address));
                const data = await resp.json();
                if (data.balance) {
                    const bal = Number(data.balance) / 1e8;
                    log('Balance: ' + bal.toFixed(2) + ' KAS', 'success');
                } else {
                    log('Error: ' + JSON.stringify(data), 'error');
                }
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function checkUTXOs(address) {
            if (!address) {
                log('Error: No address provided', 'error');
                return;
            }
            try {
                const resp = await fetch('/api/utxos?address=' + encodeURIComponent(address));
                const data = await resp.json();
                log('UTXOs: ' + JSON.stringify(data, null, 2));
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function sendKAS(privateKey, recipient, amount) {
            if (!privateKey || !recipient || !amount) {
                log('Error: Missing parameters', 'error');
                return;
            }
            
            // Validate address format
            let address = recipient;
            if (!address.startsWith('kaspatest:')) {
                address = 'kaspatest:' + address;
            }
            // Must be 61-63 chars after prefix (total 70-74)
            const addrPart = address.replace('kaspatest:', '');
            if (addrPart.length < 61 || addrPart.length > 63) {
                log('Error: Invalid address. Must be 61-63 chars after kaspatest: (got ' + addrPart.length + ')', 'error');
                return;
            }
            
            log('Sending ' + amount + ' KAS to ' + address + '...');
            
            // Use the new wallet/send endpoint
            try {
                const resp = await fetch('/api/wallet/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        privateKey: privateKey,
                        recipient: address,
                        amount: parseFloat(amount)
                    })
                });
                const data = await resp.json();
                if (data.error) {
                    log('Error: ' + data.error, 'error');
                } else if (data.txId && data.txId !== 'check explorer') {
                    log('Sent! TX: ' + data.txId, 'success');
                } else if (data.error) {
                    log('Error: ' + data.error, 'error');
                } else {
                    log('Transaction sent! Check explorer for details.', 'success');
                }
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function checkMinerStatus() {
            try {
                const stats = await fetch('/api/miner-status').then(r => r.json());
                let status = '=== MINER STATUS ===\n';
                status += 'Running: ' + (stats.running ? '✓ YES' : '✗ NO') + '\n';
                status += 'Hashrate: ' + (stats.hashrate || '0 M/s') + '\n';
                status += 'UTXO Sync: ' + (stats.utxoSync || 'N/A') + '\n';
                status += 'Accepted: ' + (stats.accepted || '0') + '\n';
                status += 'Rejected: ' + (stats.rejected || '0');
                
                log(status, stats.running ? 'success' : 'error');
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function startMiner(address, threads) {
            if (!address) {
                address = document.getElementById('walletA').value;
            }
            if (!address) {
                log('Error: Mining address required', 'error');
                return;
            }
            try {
                const resp = await fetch('/api/miner-start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address: address, threads: threads || 8 })
                });
                const data = await resp.json();
                log('Miner started: ' + (data.pid ? 'PID ' + data.pid : 'OK'), 'success');
                minerRunning = true;
                // Show miner stats
                setTimeout(async () => {
                    try {
                        const stats = await fetch('/api/miner-status').then(r => r.json());
                        const hr = stats.running ? stats.hashrate : '0.00 M/s';
                        log('Hashrate: ' + hr + ', Running: ' + stats.running, 'success');
                        // Show miner log
                        fetch('/api/shell', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ cmd: 'tail -5 miner.log' })
                        }).then(r => r.json()).then(logData => {
                            if (logData.stdout) {
                                log('--- Miner Log ---', 'success');
                                logData.stdout.split('\n').forEach(line => log(line));
                            }
                        });
                    } catch(e) {}
                }, 3000);
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function stopMiner() {
            try {
                await fetch('/api/miner-stop', { method: 'POST' });
                log('Miner stopped', 'success');
                minerRunning = false;
                // Show miner stats
                setTimeout(async () => {
                    try {
                        const stats = await fetch('/api/miner-status').then(r => r.json());
                        const hr = stats.running ? stats.hashrate : '0.00 M/s';
                        log('Hashrate: ' + hr + ', Running: ' + stats.running, 'success');
                    } catch(e) {}
                }, 1000);
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function toggleMiner(address, threads) {
            try {
                const stats = await fetch('/api/miner-status').then(r => r.json());
                minerRunning = stats.running;
            } catch(e) {
                minerRunning = false;
            }
            
            if (minerRunning) {
                await stopMiner();
            } else {
                await startMiner(address, threads);
            }
        }
        
        async function startRothschild(version, privateKey, recipient, tps, threads, priorityFee, sendAmount, randomizeFee, randomizeTxVersion, timeout, customArgs) {
            if (!privateKey || !recipient) {
                log('Error: Private key and recipient required', 'error');
                return;
            }
            
            // First, derive address from private key and check balance
            try {
                log('Checking balance...');
                const addrResp = await fetch('/api/wallet/address?privateKey=' + encodeURIComponent(privateKey));
                const addrData = await addrResp.json();
                
                if (addrData.error) {
                    log('Error: Could not derive address - ' + addrData.error, 'error');
                    return;
                }
                
                const address = addrData.address;
                log('Derived address: ' + address);
                
                // Get balance
                const balResp = await fetch('/api/wallet/balance?address=' + encodeURIComponent(address));
                const balData = await balResp.json();
                
                const balance = balData.balance || 0;
                log('Balance: ' + balance.toFixed(4) + ' KAS');
                
                if (balance <= 0) {
                    log('Error: Not enough funds (balance: ' + balance.toFixed(4) + ' KAS)', 'error');
                    return;
                }
            } catch(e) {
                log('Warning: Could not check balance - ' + e.message + ', proceeding anyway');
            }
            
            try {
                const resp = await fetch('/api/rothschild', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        version: version || 'rusty-kaspa',
                        privateKey: privateKey,
                        recipient: recipient,
                        tps: parseInt(tps) || 1,
                        threads: parseInt(threads) || 2,
                        priorityFee: parseInt(priorityFee) || 0,
                        sendAmount: sendAmount ? parseFloat(sendAmount) : null,
                        randomizeFee: randomizeFee === 'yes',
                        randomizeTxVersion: randomizeTxVersion === 'yes',
                        timeout: timeout || '0',
                        customArgs: customArgs || ''
                    })
                });
                const data = await resp.json();
                
                log('Rothschild started with version: ' + (data.version || version), 'success');
                
                // Check for insufficient funds error in stderr or stdout (but don't stop - UTXO might sync later)
                const outputStr = (data.stderr || '') + (data.stdout || '');
                if (outputStr.includes('not enough funds') || outputStr.includes('Has not enough funds')) {
                    log('⚠️ UTXO NOT SYNCED locally - Rothschild will retry automatically', 'error');
                    log('Your balance shows on public API but local node needs sync', 'error');
                    // Don't stop - let it keep retrying
                }
                
                // Also check rothschild log file after a short delay for fund errors
                setTimeout(async () => {
                    try {
                        const logResp = await fetch('/api/shell', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ cmd: 'tail -10 rothschild.log' })
                        });
                        const logData = await logResp.json();
                        if (logData.stdout && (logData.stdout.includes('not enough funds') || logData.stdout.includes('Has not enough funds'))) {
                            log('⚠️ UTXO NOT SYNCED - Balance shows ' + balance.toFixed(4) + ' KAS on API but local node needs time to sync', 'error');
                            // Don't stop - let it keep retrying
                        }
                    } catch(e) {}
                }, 3000);
                
                log('Rothschild started: ' + JSON.stringify(data), 'success');
                rothschildRunning = true;
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function stopRothschild() {
            try {
                await fetch('/api/rothschild-stop', {method: 'POST'});
                log('Rothschild stopped', 'success');
                rothschildRunning = false;
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function toggleRothschild(privateKey, recipient, tps, threads, priorityFee, randomizeFee) {
            try {
                const resp = await fetch('/api/tx-status').then(r => r.json());
                rothschildRunning = resp.running;
            } catch(e) {
                rothschildRunning = false;
            }
            
            if (rothschildRunning) {
                await stopRothschild();
            } else {
                const sendAmount = document.getElementById('rothschildAmount') ? document.getElementById('rothschildAmount').value : '';
                const timeout = document.getElementById('rothschildTimeout') ? document.getElementById('rothschildTimeout').value : '0';
                const customArgs = document.getElementById('rothschildArgs') ? document.getElementById('rothschildArgs').value : '';
                await startRothschild('rusty-kaspa', privateKey, recipient, tps, threads, priorityFee, sendAmount, randomizeFee, 'no', timeout, customArgs);
            }
        }
        
        async function compileSilverScript(source, args, output) {
            if (!source) {
                log('Error: Source file required', 'error');
                return;
            }
            try {
                log('Compiling ' + source + '...');
                const resp = await fetch('/api/silverscript-compile', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sourceFile: source,
                        constructorArgs: args || null,
                        outputFile: output || null
                    })
                });
                const data = await resp.json();
                if (data.error) {
                    log('Error: ' + data.error, 'error');
                } else {
                    log('Compiled successfully!', 'success');
                    if (data.output) {
                        log('Contract: ' + (data.output.contract_name || 'unknown'), 'success');
                        log('Script size: ' + (data.output.script ? data.output.script.length : 'N/A') + ' bytes', 'success');
                        log('Output: ' + (output || source.replace('.sil', '.json')), 'success');
                    }
                }
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        async function listSilverExamples() {
            try {
                const resp = await fetch('/api/silverscript-examples');
                const examples = await resp.json();
                log('SilverScript Examples:', 'success');
                examples.forEach(ex => {
                    log('  ' + ex.name + ' -> ' + ex.file, 'success');
                });
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        function compileContract(name, args) {
            log('Compiling ' + name + '... (demo)');
            log('Contract: ' + name + ' compiled successfully', 'success');
        }
        
        function deployContract(contractJson, privateKey) {
            log('Deploying ' + contractJson + '... (demo)');
            log('Contract deployed successfully', 'success');
        }
        
        async function runCLI(cmd) {
            log('Running: ' + cmd);
            try {
                const resp = await fetch('/api/run-cmd', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({cmd: cmd})
                });
                const data = await resp.json();
                
                // Check if generated address is valid (61-63 chars after prefix)
                if (cmd === 'generate' && data.address) {
                    const addrLen = data.address.replace('kaspatest:', '').length;
                    if (addrLen < 61 || addrLen > 63) {
                        log('WARNING: Generated address has ' + addrLen + ' chars (need 61-63). Use pre-funded wallets instead.', 'error');
                    } else {
                        log('Generated address is VALID (' + addrLen + ' chars)', 'success');
                    }
                    // Auto-fill wallet C with generated wallet (Wallet A is for miner only)
                    document.getElementById('walletC').value = data.address;
                    document.getElementById('walletCKey').value = data.privateKey || data.private_key || '';
                    refreshWallet('C');
                    log('Wallet C auto-filled with new wallet', 'success');
                }
                
                // Handle load command - fill Wallet C
                if (cmd.startsWith('load ') && data.address) {
                    const privKey = cmd.replace('load ', '').trim();
                    document.getElementById('walletC').value = data.address;
                    document.getElementById('walletCKey').value = privKey;
                    refreshWallet('C');
                    log('Loaded to Wallet C: ' + data.address.substring(0, 20) + '...', 'success');
                }
                
                log(JSON.stringify(data, null, 2), 'success');
            } catch(e) {
                log('Error: ' + e.message, 'error');
            }
        }
        
        function log(msg, type = '') {
            const output = document.getElementById('consoleOutput');
            const line = document.createElement('div');
            line.className = type === 'error' ? 'error-line' : type === 'success' ? 'success-line' : 'output-line';
            line.textContent = msg;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = '';
        }

        // ========== Wallet CLI Panel Functions ==========
        async function loadWalletCLI() {
            const privateKey = document.getElementById('walletCLIPrivateKey').value.trim();
            if (!privateKey) {
                document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #ff4444;">Error: Private key required</span>';
                return;
            }

            document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #00ff88;">Loading wallet...</span>';

            try {
                // First derive address from private key
                const loadResp = await fetch('/api/shell', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cmd: './wallet-cli.sh load ' + privateKey })
                });
                const loadData = await loadResp.json();
                const loadOutput = loadData.stdout || '';

                // Extract address from output
                let address = '';
                const addrMatch = loadOutput.match(/"address"\s*:\s*"(kaspatest:[^"]+)"/);
                if (addrMatch) {
                    address = addrMatch[1];
                }

                if (!address) {
                    document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #ff4444;">Error: Could not derive address</span><br>' + loadOutput;
                    return;
                }

                document.getElementById('walletCLIAddress').innerText = address;

                // Now get balance
                const balResp = await fetch('/api/shell', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cmd: './wallet-cli.sh balance ' + address })
                });
                const balData = await balResp.json();
                const balOutput = balData.stdout || '';

                // Extract balance
                let balance = '-';
                const balMatch = balOutput.match(/"kas"\s*:\s*([0-9.]+)/);
                if (balMatch) {
                    balance = parseFloat(balMatch[1]).toFixed(8) + ' KAS';
                }

                document.getElementById('walletCLIBalance').innerText = balance;
                document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #00ff88;">Wallet loaded successfully!</span><br>' + loadOutput.replace(/\n/g, '<br>');

            } catch(e) {
                document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #ff4444;">Error: ' + e.message + '</span>';
            }
        }

        function updateWalletCLIRPC() {
            const method = document.querySelector('input[name="walletCLIMethod"]:checked').value;
            // Just for visual feedback - no label to update now
        }

        function getWalletCLIMethod() {
            return document.querySelector('input[name="walletCLIMethod"]:checked').value;
        }

        async function sendViaWalletCLI() {
            const privateKey = document.getElementById('walletCLIPrivateKey').value.trim();
            const recipient = document.getElementById('walletCLIRecipient').value.trim();
            const amount = document.getElementById('walletCLIAmount').value.trim();
            const method = getWalletCLIMethod();

            if (!privateKey) {
                document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #ff4444;">Error: Private key required</span>';
                return;
            }
            if (!recipient) {
                document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #ff4444;">Error: Recipient address required</span>';
                return;
            }
            if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
                document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #ff4444;">Error: Valid amount required</span>';
                return;
            }

            let cmd = '';
            let methodLabel = '';
            
            if (method === 'public') {
                cmd = './wallet-cli.sh transfer ' + privateKey + ' ' + recipient + ' ' + amount;
                methodLabel = 'Public API';
            } else if (method === 'local') {
                cmd = './wallet-cli.sh transfer ' + privateKey + ' ' + recipient + ' ' + amount + ' --rpc http://localhost:16210';
                methodLabel = 'Local RPC';
            } else if (method === 'rothschild') {
                cmd = 'timeout 10s /Users/4dsto/rusty-kaspa-tn12/target/release/rothschild -k "' + privateKey + '" -a "' + recipient + '" --send-amount ' + amount + ' -s localhost:16210 -t 1';
                methodLabel = 'Rothschild';
            } else if (method === 'kaspa-send') {
                cmd = '/Users/4dsto/ktn12/target/debug/kaspa-send --rpc 127.0.0.1:17110 --network testnet-12 send --private-key ' + privateKey + ' --recipient ' + recipient + ' --amount ' + amount;
                methodLabel = 'kaspa-send (wRPC)';
            }

            document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #00ff88;">Sending ' + amount + ' KAS to ' + recipient + ' via ' + methodLabel + '...</span>';

            try {
                const resp = await fetch('/api/shell', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cmd: cmd })
                });
                const data = await resp.json();
                const output = (data.stdout || '') + (data.stderr || '');

                if (output.includes('Transfer successful') || output.includes('txid') || output.includes('Transaction') || output.includes('sent')) {
                    // Extract TXID - try multiple formats
                    const txidMatch = output.match(/"txid"\s*:\s*"([a-f0-9]+)"/i) 
                        || output.match(/TX ID:? ([a-f0-9]+)/i)
                        || output.match(/transaction:? ([a-f0-9]{64})/i)
                        || output.match(/txid:? ([a-f0-9]{64})/i)
                        || output.match(/Transaction ID:? ([a-f0-9]{64})/i);
                    const txid = txidMatch ? txidMatch[1] : 'unknown';

                    document.getElementById('walletCLIOutput').innerHTML = 
                        '<span style="color: #00ff88;">✓ Transfer successful!</span><br>' +
                        'TXID: <span style="color: #00ff88;">' + txid + '</span>';

                    // Refresh balance after short delay
                    setTimeout(loadWalletCLI, 3000);
                } else if (output.includes('Error') || output.includes('error')) {
                    document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #ff4444;">Transfer failed:</span><br>' + output.replace(/\n/g, '<br>');
                } else {
                    document.getElementById('walletCLIOutput').innerHTML = output.replace(/\n/g, '<br>');
                }

            } catch(e) {
                document.getElementById('walletCLIOutput').innerHTML = '<span style="color: #ff4444;">Error: ' + e.message + '</span>';
            }
        }

        async function startMinerFromPanel10() {
            const address = document.getElementById('walletCLIAddress').innerText;
            if (!address || address === '-' || !address.startsWith('kaspatest:')) {
                document.getElementById('walletCLIMinerStatus').innerHTML = '<span style="color: #ff4444;">Load a wallet first to get an address</span>';
                return;
            }

            document.getElementById('walletCLIMinerStatus').innerHTML = '<span style="color: #00ff88;">Starting miner to ' + address + '...</span>';

            try {
                const resp = await fetch('/api/miner-start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address: address, threads: 4 })
                });
                const data = await resp.json();
                
                if (data.started || data.pid) {
                    document.getElementById('walletCLIMinerStatus').innerHTML = '<span style="color: #00ff88;">Miner started! PID: ' + data.pid + '</span>';
                    document.getElementById('walletCLIMinerBtn').innerText = 'Miner Running (Click to Stop)';
                    document.getElementById('walletCLIMinerBtn').onclick = stopMinerFromPanel10;
                } else {
                    document.getElementById('walletCLIMinerStatus').innerHTML = '<span style="color: #ff4444;">Failed to start miner</span>';
                }
            } catch(e) {
                document.getElementById('walletCLIMinerStatus').innerHTML = '<span style="color: #ff4444;">Error: ' + e.message + '</span>';
            }
        }

        async function stopMinerFromPanel10() {
            try {
                await fetch('/api/miner-stop', { method: 'POST' });
                document.getElementById('walletCLIMinerStatus').innerHTML = '<span style="color: #ffaa00;">Miner stopped</span>';
                document.getElementById('walletCLIMinerBtn').innerText = 'Start Miner to This Address';
                document.getElementById('walletCLIMinerBtn').onclick = startMinerFromPanel10;
            } catch(e) {
                document.getElementById('walletCLIMinerStatus').innerHTML = '<span style="color: #ff4444;">Error: ' + e.message + '</span>';
            }
        }

        function handleConsoleEnter(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('consoleInput');
                const cmd = input.value.trim();
                if (cmd) {
                    log('$ ' + cmd, 'cmd-line');
                    
                    // Execute shell command directly
                    fetch('/api/shell', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ cmd: cmd })
                    })
                    .then(resp => resp.json())
                    .then(data => {
                        if (data.stderr) {
                            log(data.stderr, 'error');
                        }
                        if (data.stdout) {
                            log(data.stdout, 'success');
                        }
                        if (data.error && !data.stdout && !data.stderr) {
                            log('Error: ' + data.error, 'error');
                        }
                    })
                    .catch(e => {
                        log('Error: ' + e.message, 'error');
                    });
                    
                    input.value = '';
                }
            }
        }
        
        init();
    </script>
</body>
</html>
